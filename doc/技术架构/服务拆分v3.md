# 外卖平台微服务架构方案 - 可视化设计

## 1. 服务拆分总览表

| 服务名称 | 端口 | 核心职责 | 数据ownership | 主要对外API数量 | 部署优先级 |
|---------|------|----------|---------------|----------------|------------|
| `gateway-service` | 8080 | 统一入口控制 | 无业务数据 | 路由转发 | ⭐⭐⭐ 最高 |
| `user-service` | 8081 | 用户账户管理 | 用户信息、地址信息 | 8个 | ⭐⭐⭐ 最高 |
| `merchant-service` | 8082 | 商户商品管理 | 商户信息、商品信息、库存 | 12个 | ⭐⭐⭐ 最高 |
| `order-service` | 8083 | 订单交易管理 | 订单信息、支付记录 | 10个 | ⭐⭐⭐ 最高 |
| `delivery-service` | 8084 | 配送履约管理 | 骑手信息、配送任务 | 9个 | ⭐⭐ 高 |
| `promotion-service` | 8085 | 营销促销管理 | 优惠券、活动规则 | 7个 | ⭐ 中 |
| `wallet-service` | 8086 | 钱包财务管理 | 账户余额、资金流水 | 6个 | ⭐⭐ 高 |
| `admin-service` | 8087 | 运营管理工具 | 权限信息、系统配置 | 15个 | ⭐ 中 |

## 2. 服务职责矩阵表

| 功能领域 | Gateway | User | Merchant | Order | Delivery | Promotion | Wallet | Admin |
|---------|---------|------|----------|-------|----------|-----------|---------|-------|
| **用户管理** | 路由 | ✅主责 | - | - | - | - | - | 📊统计 |
| **商户管理** | 路由 | - | ✅主责 | - | - | - | - | 📊审核 |
| **商品管理** | 路由 | - | ✅主责 | 🔗调用 | - | - | - | 📊统计 |
| **订单管理** | 路由 | - | - | ✅主责 | 📤事件 | 🔗调用 | 📤事件 | 📊统计 |
| **支付管理** | 路由 | - | - | ✅主责 | - | 🔗调用 | 📤事件 | 📊统计 |
| **配送管理** | 路由 | - | - | 📤事件 | ✅主责 | - | 📤事件 | 📊统计 |
| **营销管理** | 路由 | - | - | 🔗调用 | - | ✅主责 | - | 📊配置 |
| **财务管理** | 路由 | - | - | - | - | - | ✅主责 | 📊统计 |
| **权限管理** | 🔒鉴权 | - | - | - | - | - | - | ✅主责 |

**图例**：✅主责 🔗同步调用 📤异步事件 📊数据统计 🔒权限控制

## 3. 服务依赖关系图

```mermaid
graph TD
    %% 客户端层
    subgraph "客户端应用"
        A1[用户小程序]
        A2[骑手小程序] 
        A3[商户小程序]
        A4[管理后台]
    end

    %% 网关层
    subgraph "接入层"
        B[Gateway Service<br/>:8080]
    end

    %% 业务服务层
    subgraph "业务服务层"
        C1[User Service<br/>:8081<br/>用户账户]
        C2[Merchant Service<br/>:8082<br/>商户商品]
        C3[Order Service<br/>:8083<br/>订单交易]
        C4[Delivery Service<br/>:8084<br/>配送履约]
        C5[Promotion Service<br/>:8085<br/>营销促销]
        C6[Wallet Service<br/>:8086<br/>钱包财务]
        C7[Admin Service<br/>:8087<br/>运营管理]
    end

    %% 基础设施层
    subgraph "基础设施"
        D1[(MySQL)]
        D2[(Redis)]
        D3[RabbitMQ]
        D4[微信支付API]
    end

    %% 客户端到网关
    A1 --> B
    A2 --> B
    A3 --> B
    A4 --> B

    %% 网关到服务
    B --> C1
    B --> C2
    B --> C3
    B --> C4
    B --> C5
    B --> C6
    B --> C7

    %% 服务间同步调用（实线）
    C3 -.->|获取用户地址| C1
    C3 -.->|校验商品库存| C2
    C3 -.->|价格计算| C5
    C7 -.->|数据统计| C1
    C7 -.->|数据统计| C2
    C7 -.->|数据统计| C3
    C7 -.->|数据统计| C4
    C7 -.->|数据统计| C6

    %% 服务间异步事件（虚线）
    C3 ==>|订单事件| D3
    D3 ==>|新配送任务| C4
    D3 ==>|资金变动| C6

    %% 服务到基础设施
    C1 --> D1
    C2 --> D1
    C3 --> D1
    C4 --> D1
    C5 --> D1
    C6 --> D1
    C7 --> D1

    C1 --> D2
    C3 --> D2
    C4 --> D2
    C5 --> D2

    C3 --> D4

    %% 样式定义
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef gateway fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef service fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef infrastructure fill:#fff3e0,stroke:#e65100,stroke-width:2px

    class A1,A2,A3,A4 client
    class B gateway
    class C1,C2,C3,C4,C5,C6,C7 service
    class D1,D2,D3,D4 infrastructure
```

**图例说明**：
- **实线箭头**: 直接API调用
- **虚线箭头**: 同步调用（必须等待响应）
- **双线箭头**: 异步事件通信（通过MQ）

## 4. 核心业务流程图

### 4.1 用户下单流程

```mermaid
sequenceDiagram
    participant U as 用户小程序
    participant G as Gateway<br/>:8080
    participant US as User Service<br/>:8081
    participant MS as Merchant Service<br/>:8082
    participant PS as Promotion Service<br/>:8085
    participant OS as Order Service<br/>:8083
    participant MQ as RabbitMQ
    participant DS as Delivery Service<br/>:8084
    participant WS as Wallet Service<br/>:8086

    Note over U: 用户选择商品，点击下单

    U->>G: 1. 提交订单请求
    G->>OS: 路由到订单服务

    Note over OS: 订单服务协调整个下单流程

    OS->>US: 2. 获取用户配送地址
    US-->>OS: 返回地址信息

    OS->>MS: 3. 校验商品信息和库存
    MS-->>OS: 返回商品详情，扣减库存

    OS->>PS: 4. 计算订单价格（含优惠）
    PS-->>OS: 返回最终价格

    OS->>OS: 5. 创建订单记录

    OS->>OS: 6. 调用微信支付API
    OS-->>G: 返回支付参数
    G-->>U: 返回支付信息

    Note over U: 用户完成微信支付

    U->>G: 7. 支付成功回调
    G->>OS: 处理支付回调
    OS->>OS: 更新订单状态为已支付

    Note over OS: 支付成功后，异步通知相关服务

    OS->>MQ: 8. 发送订单支付成功事件
    MQ->>DS: 通知配送服务（新配送任务）
    MQ->>WS: 通知钱包服务（资金变动）

    DS->>DS: 创建配送任务，等待骑手抢单
    WS->>WS: 更新商户收入，扣除平台服务费

    Note over U: 用户可查看订单状态，等待配送
```

### 4.2 骑手配送流程

```mermaid
sequenceDiagram
    participant R as 骑手小程序
    participant G as Gateway<br/>:8080
    participant DS as Delivery Service<br/>:8084
    participant MQ as RabbitMQ
    participant OS as Order Service<br/>:8083
    participant WS as Wallet Service<br/>:8086

    Note over R: 骑手查看待抢订单

    R->>G: 1. 查询附近待抢订单
    G->>DS: 路由到配送服务
    DS-->>G: 返回订单列表
    G-->>R: 显示可抢订单

    R->>G: 2. 选择订单进行抢单
    G->>DS: 抢单请求
    DS->>DS: 分布式锁，检查订单状态
    DS->>DS: 分配订单给骑手
    DS-->>G: 抢单成功
    G-->>R: 返回配送任务详情

    Note over R: 骑手前往商家取餐

    R->>G: 3. 更新配送状态：已取餐
    G->>DS: 更新配送状态
    DS->>MQ: 发送状态变更事件
    MQ->>OS: 通知订单服务更新状态

    Note over R: 骑手配送中

    R->>G: 4. 实时位置上报
    G->>DS: 更新骑手位置

    R->>G: 5. 更新配送状态：已送达
    G->>DS: 配送完成
    DS->>DS: 计算配送费收入

    DS->>MQ: 6. 发送配送完成事件
    MQ->>OS: 通知订单服务（订单完成）
    MQ->>WS: 通知钱包服务（骑手结算）

    OS->>OS: 订单状态改为已完成
    WS->>WS: 增加骑手收入账户余额

    Note over R: 骑手可查看收入明细
```

### 4.3 商户管理流程

```mermaid
sequenceDiagram
    participant M as 商户小程序
    participant G as Gateway<br/>:8080
    participant MS as Merchant Service<br/>:8082
    participant OS as Order Service<br/>:8083
    participant AS as Admin Service<br/>:8087

    Note over M: 商户日常经营管理

    M->>G: 1. 查看今日订单
    G->>OS: 查询商户订单
    OS-->>G: 返回订单列表
    G-->>M: 显示订单信息

    M->>G: 2. 接受/拒绝订单
    G->>OS: 更新订单状态
    OS-->>G: 状态更新成功
    G-->>M: 操作成功

    M->>G: 3. 管理商品（上架/下架/改价）
    G->>MS: 商品管理操作
    MS->>MS: 更新商品信息
    MS-->>G: 操作成功
    G-->>M: 商品更新成功

    M->>G: 4. 切换营业状态
    G->>MS: 更新营业状态
    MS-->>G: 状态更新成功
    G-->>M: 营业状态已更新

    Note over AS: 后台管理员监控

    AS->>MS: 5. 定期统计商户经营数据
    MS-->>AS: 返回商户统计信息

    AS->>OS: 6. 统计订单交易数据
    OS-->>AS: 返回交易统计
```

## 5. 数据流转图

```mermaid
flowchart TD
    subgraph "用户端交互"
        A[用户小程序] --> B[选择商品]
        B --> C[确认订单]
        C --> D[发起支付]
    end

    subgraph "订单处理核心"
        E[Order Service] --> F{库存检查}
        F -->|充足| G[价格计算]
        F -->|不足| H[库存不足]
        G --> I[创建订单]
        I --> J[调用支付]
    end

    subgraph "支付成功后"
        K[支付回调] --> L[MQ事件]
        L --> M[配送任务]
        L --> N[资金结算]
        L --> O[库存扣减]
    end

    subgraph "履约阶段"
        P[骑手抢单] --> Q[商家出餐]
        Q --> R[开始配送]
        R --> S[配送完成]
        S --> T[订单完成]
    end

    %% 连接各个阶段
    D --> E
    J --> K
    M --> P
    T --> U[结算分账]

    %% 样式
    classDef userAction fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef orderProcess fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef asyncProcess fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef fulfillment fill:#fce4ec,stroke:#c2185b,stroke-width:2px

    class A,B,C,D userAction
    class E,F,G,I,J orderProcess
    class K,L,M,N,O asyncProcess
    class P,Q,R,S,T fulfillment
```

## 6. 服务能力评估表

| 服务 | 预估QPS | 主要瓶颈 | 扩展方案 | 监控重点 |
|------|---------|----------|----------|----------|
| Gateway | 1000+ | CPU/内存 | 多实例+负载均衡 | 响应时间、错误率 |
| User | 200 | 数据库连接 | 读写分离+缓存 | 登录成功率 |
| Merchant | 300 | 商品查询 | Redis缓存 | 商品查询延迟 |
| Order | 500+ | 数据库写入 | 分库分表 | 订单创建成功率 |
| Delivery | 200 | 位置计算 | 地理位置索引 | 抢单响应时间 |
| Promotion | 150 | 价格计算 | 算法优化+缓存 | 计算准确性 |
| Wallet | 100 | 资金安全 | 分布式事务 | 账务平衡检查 |
| Admin | 50 | 复杂查询 | 数据仓库 | 报表生成时间 |

## 7. 部署架构建议

### MVP阶段（单机部署）
```
[Nginx] → [Gateway] → [User|Merchant|Order|Delivery|Promotion|Wallet|Admin]
                           ↓
[MySQL Master] ← → [Redis] ← → [RabbitMQ]
```

### 扩展阶段（分布式部署）
```
[负载均衡] → [Gateway集群] → [微服务集群]
                              ↓
[MySQL集群] ← → [Redis集群] ← → [RabbitMQ集群]
```

这个可视化方案清晰展示了：
- ✅ **8个服务的职责边界**
- ✅ **服务间的调用依赖关系**
- ✅ **核心业务流程的服务协作**
- ✅ **数据流转和异步事件**
- ✅ **部署和扩展建议**

现在整个架构方案既有清晰的文字说明，又有直观的图表展示，非常适合与甲方进行技术对接！