# è´¡äº«è‡»é€‰2.0 - éª‘æ‰‹æŠ¢å•é…é€ç³»ç»Ÿè®¾è®¡

## é¡¹ç›®æ¦‚è¿°

è´¡äº«è‡»é€‰2.0æ˜¯ä¸€ä¸ªå¤–å–+ç”µå•†+å›¢è´­çš„ç»¼åˆå¹³å°ï¼Œæœ¬æ–‡æ¡£ä¸“æ³¨äº**å¾®ä¿¡å°ç¨‹åºç«¯**éª‘æ‰‹æŠ¢å•é…é€ç³»ç»Ÿçš„è®¾è®¡ï¼Œå‚è€ƒç¾å›¢ç­‰ä¸»æµå¤–å–å¹³å°çš„è¿è¥æ¨¡å¼ã€‚

### ğŸ”§ æŠ€æœ¯æ¶æ„è¯´æ˜

- **å‰ç«¯**: å¾®ä¿¡å°ç¨‹åºï¼ˆç”¨æˆ·ç«¯ã€éª‘æ‰‹ç«¯ã€å•†æˆ·ç«¯ï¼‰
- **é€šä¿¡æ–¹å¼**: HTTPè½®è¯¢ + å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æ¨é€ï¼ˆæ— WebSocketï¼‰
- **ä½ç½®æœåŠ¡**: å°ç¨‹åºåŸç”ŸAPI + è…¾è®¯åœ°å›¾
- **æ¨é€é€šçŸ¥**: å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯/è®¢é˜…æ¶ˆæ¯

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. éª‘æ‰‹ç«¯æ ¸å¿ƒåŠŸèƒ½

- **è®¢å•æŠ¢å•/æ¥å•**ï¼šå®æ—¶è®¢å•æ¨é€ï¼Œéª‘æ‰‹ä¸»åŠ¨æŠ¢å•
- **è®¢å•æ´¾é€åˆ—è¡¨**ï¼šå½“å‰é…é€ä»»åŠ¡ç®¡ç†
- **è·¯çº¿å¯¼èˆª**ï¼šé…é€è·¯å¾„ä¼˜åŒ–å’Œå¯¼èˆª
- **ä»»åŠ¡ä¸­å¿ƒ**ï¼šå†å²è®¢å•ã€æ”¶å…¥ç»Ÿè®¡
- **é…é€çŠ¶æ€æ›´æ–°**ï¼šåˆ°åº—/å–é¤/é…é€ä¸­/å·²é€è¾¾
- **è´¦æˆ·ç®¡ç†**ï¼šæ”¶å…¥æ˜ç»†ã€æç°åŠŸèƒ½
- **æœåŠ¡è¯„åˆ†**ï¼šç”¨æˆ·è¯„ä»·æŸ¥çœ‹

### 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

#### å¾®æœåŠ¡æ¶æ„æ€»è§ˆ

```mermaid
graph LR
    A[ç”¨æˆ·ç«¯] --> B[APIç½‘å…³]
    C[å•†æˆ·ç«¯] --> B
    D[éª‘æ‰‹ç«¯] --> B
    E[ç®¡ç†åå°] --> B
    
    B --> F[ç”¨æˆ·æœåŠ¡]
    B --> G[è®¢å•æœåŠ¡]
    B --> H[å•†å“æœåŠ¡]
    B --> I[å•†æˆ·æœåŠ¡]
    B --> J[éª‘æ‰‹æœåŠ¡]
    B --> K[æ”¯ä»˜æœåŠ¡]
    B --> L[è¥é”€æœåŠ¡]
    B --> M[é€šçŸ¥æœåŠ¡]
    B --> N[åœ°ç†ä½ç½®æœåŠ¡]
    
    G --> O[æ¶ˆæ¯é˜Ÿåˆ—MQ]
    O --> P[è®¢å•çŠ¶æ€æ›´æ–°]
    O --> Q[éª‘æ‰‹æ¨é€]
    
    R[(MySQL)] --> F
    R --> G
    R --> H
    R --> I
    R --> J
    
    S[(Redis)] --> T[è®¢å•ç¼“å­˜]
    S --> U[ä½ç½®ç¼“å­˜]
    S --> V[æŠ¢å•é”]
    
    W[è…¾è®¯åœ°å›¾API] --> N
    X[å¾®ä¿¡æ”¯ä»˜] --> K
    Y[æ”¯ä»˜å®] --> K
```

## éª‘æ‰‹æŠ¢å•æµç¨‹è®¾è®¡

### 1. æ•´ä½“ä¸šåŠ¡æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·ä¸‹å•å¹¶æ”¯ä»˜] --> B[è®¢å•æœåŠ¡åˆ›å»ºè®¢å•]
    B --> C[è®¡ç®—è®¢å•é…é€èŒƒå›´]
    C --> D[æŸ¥è¯¢èŒƒå›´å†…å¯ç”¨éª‘æ‰‹]
    D --> E[æ¨é€è®¢å•åˆ°éª‘æ‰‹ç«¯]
    E --> F[éª‘æ‰‹æŸ¥çœ‹é™„è¿‘è®¢å•]
    F --> G[éª‘æ‰‹é€‰æ‹©è®¢å•æŠ¢å•]
    G --> H[ç³»ç»Ÿåˆ†é…è®¢å•ç»™éª‘æ‰‹]
    H --> I[æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå¾…å–é¤]
    I --> J[éª‘æ‰‹å‰å¾€å•†å®¶å–é¤]
    J --> K[éª‘æ‰‹æ›´æ–°çŠ¶æ€ï¼šå·²åˆ°åº—]
    K --> L[éª‘æ‰‹æ›´æ–°çŠ¶æ€ï¼šå·²å–é¤]
    L --> M[éª‘æ‰‹å‰å¾€é…é€åœ°å€]
    M --> N[éª‘æ‰‹æ›´æ–°çŠ¶æ€ï¼šé…é€ä¸­]
    N --> O[éª‘æ‰‹æ›´æ–°çŠ¶æ€ï¼šå·²é€è¾¾]
    O --> P[è®¢å•å®Œæˆï¼Œç»“ç®—æ”¶å…¥]
    P --> Q[ç”¨æˆ·è¯„ä»·éª‘æ‰‹]
```

### 2. åŸºäºä½ç½®çš„é™„è¿‘è®¢å•æŸ¥è¯¢

#### æ•°æ®åº“è¡¨è®¾è®¡

```sql
-- è®¢å•è¡¨
CREATE TABLE `tb_order` (
    `id` int NOT NULL AUTO_INCREMENT,
    `order_no` varchar(50) NOT NULL COMMENT 'è®¢å•å·',
    `user_id` int NOT NULL COMMENT 'ç”¨æˆ·ID',
    `shop_id` int NOT NULL COMMENT 'å•†å®¶ID',
    `shop_longitude` decimal(10,7) NOT NULL COMMENT 'å•†å®¶ç»åº¦',
    `shop_latitude` decimal(10,7) NOT NULL COMMENT 'å•†å®¶çº¬åº¦',
    `delivery_longitude` decimal(10,7) NOT NULL COMMENT 'é…é€åœ°å€ç»åº¦',
    `delivery_latitude` decimal(10,7) NOT NULL COMMENT 'é…é€åœ°å€çº¬åº¦',
    `delivery_fee` decimal(8,2) NOT NULL COMMENT 'é…é€è´¹',
    `distance` decimal(8,2) NOT NULL COMMENT 'é…é€è·ç¦»(å…¬é‡Œ)',
    `status` tinyint NOT NULL DEFAULT 1 COMMENT 'è®¢å•çŠ¶æ€',
    `rider_id` int DEFAULT NULL COMMENT 'éª‘æ‰‹ID',
    `expected_delivery_time` int NOT NULL COMMENT 'é¢„è®¡é…é€æ—¶é•¿(åˆ†é’Ÿ)',
    `created_time` datetime NOT NULL,
    `grab_deadline` datetime NOT NULL COMMENT 'æŠ¢å•æˆªæ­¢æ—¶é—´',
    PRIMARY KEY (`id`),
    KEY `idx_grab_orders` (`status`, `grab_deadline`, `shop_longitude`, `shop_latitude`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•è¡¨';

-- éª‘æ‰‹è¡¨
CREATE TABLE `tb_rider` (
    `id` int NOT NULL AUTO_INCREMENT,
    `phone` varchar(20) NOT NULL COMMENT 'æ‰‹æœºå·',
    `name` varchar(50) NOT NULL COMMENT 'å§“å',
    `current_longitude` decimal(10,7) DEFAULT NULL COMMENT 'å½“å‰ç»åº¦',
    `current_latitude` decimal(10,7) DEFAULT NULL COMMENT 'å½“å‰çº¬åº¦',
    `status` tinyint NOT NULL DEFAULT 1 COMMENT 'éª‘æ‰‹çŠ¶æ€ï¼š1=ç©ºé—²ï¼Œ2=é…é€ä¸­ï¼Œ3=ä¼‘æ¯',
    `max_concurrent_orders` tinyint NOT NULL DEFAULT 3 COMMENT 'æœ€å¤§å¹¶å‘è®¢å•æ•°',
    `current_orders_count` tinyint NOT NULL DEFAULT 0 COMMENT 'å½“å‰é…é€è®¢å•æ•°',
    `service_range` decimal(5,2) NOT NULL DEFAULT 5.0 COMMENT 'æœåŠ¡èŒƒå›´(å…¬é‡Œ)',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_phone` (`phone`),
    KEY `idx_location_status` (`status`, `current_longitude`, `current_latitude`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='éª‘æ‰‹è¡¨';
```

#### é™„è¿‘è®¢å•æŸ¥è¯¢ç®—æ³•

```java
/**
 * éª‘æ‰‹æŸ¥è¯¢é™„è¿‘å¯æŠ¢è®¢å•
 * @param riderLng éª‘æ‰‹ç»åº¦
 * @param riderLat éª‘æ‰‹çº¬åº¦
 * @param serviceRange æœåŠ¡èŒƒå›´(å…¬é‡Œ)
 * @return å¯æŠ¢è®¢å•åˆ—è¡¨
 */
public List<OrderVO> findNearbyGrabbableOrders(BigDecimal riderLng, BigDecimal riderLat, BigDecimal serviceRange) {
    // 1. è®¡ç®—ç»çº¬åº¦èŒƒå›´ï¼ˆå¿«é€Ÿç­›é€‰ï¼‰
    BigDecimal lngDelta = serviceRange.divide(new BigDecimal("111.320"), 6, RoundingMode.HALF_UP);
    BigDecimal latDelta = serviceRange.divide(new BigDecimal("110.540"), 6, RoundingMode.HALF_UP);
    
    BigDecimal minLng = riderLng.subtract(lngDelta);
    BigDecimal maxLng = riderLng.add(lngDelta);
    BigDecimal minLat = riderLat.subtract(latDelta);
    BigDecimal maxLat = riderLat.add(latDelta);
    
    // 2. SQLæŸ¥è¯¢å¯æŠ¢è®¢å•
    String sql = """
        SELECT 
            o.*,
            (6371 * 2 * ASIN(SQRT(
                POWER(SIN((? - shop_latitude) * PI() / 180 / 2), 2) +
                COS(? * PI() / 180) * COS(shop_latitude * PI() / 180) *
                POWER(SIN((? - shop_longitude) * PI() / 180 / 2), 2)
            ))) as shop_distance
        FROM tb_order o
        WHERE o.status = 2  -- å¾…æŠ¢å•çŠ¶æ€
            AND o.rider_id IS NULL
            AND o.grab_deadline > NOW()
            AND o.shop_longitude BETWEEN ? AND ?
            AND o.shop_latitude BETWEEN ? AND ?
        HAVING shop_distance <= ?
        ORDER BY 
            o.delivery_fee DESC,  -- é…é€è´¹é«˜çš„ä¼˜å…ˆ
            shop_distance ASC,    -- è·ç¦»è¿‘çš„ä¼˜å…ˆ
            o.created_time ASC    -- ä¸‹å•æ—©çš„ä¼˜å…ˆ
        LIMIT 20
        """;
    
    return orderMapper.selectNearbyOrders(sql, riderLat, riderLat, riderLng, 
                                         minLng, maxLng, minLat, maxLat, serviceRange);
}
```

### 3. æŠ¢å•æœºåˆ¶è®¾è®¡

#### æŠ¢å•æµç¨‹

```mermaid
sequenceDiagram
    participant R as éª‘æ‰‹ç«¯
    participant G as APIç½‘å…³
    participant OS as è®¢å•æœåŠ¡
    participant RS as éª‘æ‰‹æœåŠ¡
    participant C as Redisç¼“å­˜
    participant MQ as æ¶ˆæ¯é˜Ÿåˆ—
    
    R->>G: è¯·æ±‚æŠ¢å•(è®¢å•ID, éª‘æ‰‹ID)
    G->>OS: è½¬å‘æŠ¢å•è¯·æ±‚
    
    OS->>C: å°è¯•è·å–è®¢å•åˆ†å¸ƒå¼é”
    alt è·å–é”æˆåŠŸ
        C-->>OS: é”è·å–æˆåŠŸ
        OS->>OS: æ ¡éªŒè®¢å•çŠ¶æ€å’Œéª‘æ‰‹çŠ¶æ€
        alt æ ¡éªŒé€šè¿‡
            OS->>OS: æ›´æ–°è®¢å•çŠ¶æ€å’Œéª‘æ‰‹ID
            OS->>RS: æ›´æ–°éª‘æ‰‹å½“å‰è®¢å•æ•°
            OS->>MQ: å‘é€æŠ¢å•æˆåŠŸæ¶ˆæ¯
            OS-->>G: æŠ¢å•æˆåŠŸ
            G-->>R: è¿”å›æˆåŠŸ
            
            MQ->>OS: é€šçŸ¥å…¶ä»–éª‘æ‰‹è®¢å•å·²è¢«æŠ¢
            OS->>R: æ¨é€è®¢å•è¯¦æƒ…(å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯)
        else æ ¡éªŒå¤±è´¥
            OS-->>G: æŠ¢å•å¤±è´¥(è®¢å•å·²è¢«æŠ¢æˆ–éª‘æ‰‹ä¸å¯ç”¨)
            G-->>R: è¿”å›å¤±è´¥ä¿¡æ¯
        end
        OS->>C: é‡Šæ”¾åˆ†å¸ƒå¼é”
    else è·å–é”å¤±è´¥
        C-->>OS: é”è·å–å¤±è´¥
        OS-->>G: æŠ¢å•å¤±è´¥(è®¢å•æ­£åœ¨è¢«å¤„ç†)
        G-->>R: è¿”å›å¤±è´¥ä¿¡æ¯
    end
```

#### é˜²æ­¢é‡å¤æŠ¢å•çš„Redisé”æœºåˆ¶

```java
@Service
public class OrderGrabService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * éª‘æ‰‹æŠ¢å•
     */
    @Transactional(rollbackFor = Exception.class)
    public Result<String> grabOrder(Integer orderId, Integer riderId) {
        String lockKey = "order:grab:lock:" + orderId;
        String lockValue = riderId + ":" + System.currentTimeMillis();
        
        try {
            // 1. è·å–åˆ†å¸ƒå¼é”ï¼Œ30ç§’è¿‡æœŸ
            Boolean lockAcquired = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, Duration.ofSeconds(30));
            
            if (!lockAcquired) {
                return Result.fail("è¯¥è®¢å•æ­£åœ¨è¢«å¤„ç†ï¼Œè¯·ç¨åé‡è¯•");
            }
            
            // 2. æ ¡éªŒè®¢å•çŠ¶æ€
            Order order = orderMapper.selectById(orderId);
            if (order == null || order.getRiderId() != null) {
                return Result.fail("è®¢å•ä¸å­˜åœ¨æˆ–å·²è¢«æŠ¢");
            }
            
            if (order.getStatus() != OrderStatus.WAIT_GRAB) {
                return Result.fail("è®¢å•çŠ¶æ€ä¸å…è®¸æŠ¢å•");
            }
            
            if (order.getGrabDeadline().before(new Date())) {
                return Result.fail("æŠ¢å•æ—¶é—´å·²è¿‡æœŸ");
            }
            
            // 3. æ ¡éªŒéª‘æ‰‹çŠ¶æ€
            Rider rider = riderMapper.selectById(riderId);
            if (rider == null || rider.getStatus() != RiderStatus.AVAILABLE) {
                return Result.fail("éª‘æ‰‹çŠ¶æ€ä¸å¯ç”¨");
            }
            
            if (rider.getCurrentOrdersCount() >= rider.getMaxConcurrentOrders()) {
                return Result.fail("å½“å‰é…é€è®¢å•å·²è¾¾ä¸Šé™");
            }
            
            // 4. æ›´æ–°è®¢å•å’Œéª‘æ‰‹çŠ¶æ€
            order.setRiderId(riderId);
            order.setStatus(OrderStatus.WAIT_PICKUP);
            order.setGrabTime(new Date());
            orderMapper.updateById(order);
            
            rider.setCurrentOrdersCount(rider.getCurrentOrdersCount() + 1);
            riderMapper.updateById(rider);
            
            // 5. å‘é€æ¶ˆæ¯é€šçŸ¥
            OrderGrabMessage message = new OrderGrabMessage();
            message.setOrderId(orderId);
            message.setRiderId(riderId);
            message.setGrabTime(new Date());
            mqProducer.sendMessage("order.grab.success", message);
            
            return Result.success("æŠ¢å•æˆåŠŸ");
            
        } finally {
            // é‡Šæ”¾é”
            String currentValue = redisTemplate.opsForValue().get(lockKey);
            if (lockValue.equals(currentValue)) {
                redisTemplate.delete(lockKey);
            }
        }
    }
}
```

### 4. é…é€çŠ¶æ€æœºè®¾è®¡

#### è®¢å•çŠ¶æ€æšä¸¾

```java
public enum OrderStatus {
    WAIT_PAYMENT(1, "å¾…æ”¯ä»˜"),
    WAIT_GRAB(2, "å¾…æŠ¢å•"),
    WAIT_PICKUP(3, "å¾…å–é¤"),
    RIDER_ARRIVED(4, "éª‘æ‰‹å·²åˆ°åº—"),
    PICKED_UP(5, "å·²å–é¤"),
    DELIVERING(6, "é…é€ä¸­"),
    DELIVERED(7, "å·²é€è¾¾"),
    COMPLETED(8, "å·²å®Œæˆ"),
    CANCELLED(9, "å·²å–æ¶ˆ");
}
```

#### çŠ¶æ€æ›´æ–°æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> å¾…æ”¯ä»˜
    å¾…æ”¯ä»˜ --> å¾…æŠ¢å•: æ”¯ä»˜æˆåŠŸ
    å¾…æ”¯ä»˜ --> å·²å–æ¶ˆ: æ”¯ä»˜è¶…æ—¶/ç”¨æˆ·å–æ¶ˆ
    
    å¾…æŠ¢å• --> å¾…å–é¤: éª‘æ‰‹æŠ¢å•æˆåŠŸ
    å¾…æŠ¢å• --> å·²å–æ¶ˆ: è¶…æ—¶æ— äººæŠ¢å•
    
    å¾…å–é¤ --> éª‘æ‰‹å·²åˆ°åº—: éª‘æ‰‹ç‚¹å‡»åˆ°åº—
    éª‘æ‰‹å·²åˆ°åº— --> å·²å–é¤: éª‘æ‰‹ç‚¹å‡»å–é¤
    å·²å–é¤ --> é…é€ä¸­: éª‘æ‰‹å¼€å§‹é…é€
    é…é€ä¸­ --> å·²é€è¾¾: éª‘æ‰‹ç‚¹å‡»é€è¾¾
    å·²é€è¾¾ --> å·²å®Œæˆ: ç³»ç»Ÿè‡ªåŠ¨/ç”¨æˆ·ç¡®è®¤
    
    å¾…å–é¤ --> å·²å–æ¶ˆ: éª‘æ‰‹/å•†å®¶å–æ¶ˆ
    éª‘æ‰‹å·²åˆ°åº— --> å·²å–æ¶ˆ: å¼‚å¸¸å–æ¶ˆ
    å·²å–é¤ --> å·²å–æ¶ˆ: å¼‚å¸¸å–æ¶ˆ
    é…é€ä¸­ --> å·²å–æ¶ˆ: å¼‚å¸¸å–æ¶ˆ
```

#### çŠ¶æ€æ›´æ–°APIè®¾è®¡

```java
@RestController
@RequestMapping("/api/rider/order")
public class RiderOrderController {
    
    /**
     * æ›´æ–°é…é€çŠ¶æ€
     */
    @PostMapping("/update-status")
    public Result<String> updateDeliveryStatus(@RequestBody UpdateStatusRequest request) {
        // 1. æ ¡éªŒéª‘æ‰‹æƒé™
        if (!validateRiderPermission(request.getRiderId(), request.getOrderId())) {
            return Result.fail("æ— æƒæ“ä½œæ­¤è®¢å•");
        }
        
        // 2. çŠ¶æ€æœºæ ¡éªŒå’Œæ›´æ–°
        OrderStatus currentStatus = orderService.getOrderStatus(request.getOrderId());
        OrderStatus targetStatus = request.getTargetStatus();
        
        if (!isValidStatusTransition(currentStatus, targetStatus)) {
            return Result.fail("çŠ¶æ€è½¬æ¢ä¸åˆæ³•");
        }
        
        // 3. æ‰§è¡ŒçŠ¶æ€æ›´æ–°
        switch (targetStatus) {
            case RIDER_ARRIVED:
                return handleRiderArrived(request);
            case PICKED_UP:
                return handlePickedUp(request);
            case DELIVERING:
                return handleDelivering(request);
            case DELIVERED:
                return handleDelivered(request);
            default:
                return Result.fail("ä¸æ”¯æŒçš„çŠ¶æ€æ›´æ–°");
        }
    }
    
    /**
     * éª‘æ‰‹å·²åˆ°åº—
     */
    private Result<String> handleRiderArrived(UpdateStatusRequest request) {
        Order order = orderService.getById(request.getOrderId());
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus(OrderStatus.RIDER_ARRIVED.getCode());
        order.setArriveTime(new Date());
        if (request.getLongitude() != null && request.getLatitude() != null) {
            order.setArriveLocation(request.getLongitude() + "," + request.getLatitude());
        }
        orderService.updateById(order);
        
        // é€šçŸ¥å•†å®¶å‡†å¤‡å•†å“
        notificationService.notifyMerchant(order.getShopId(), "éª‘æ‰‹å·²åˆ°åº—ï¼Œè¯·å‡†å¤‡å•†å“", order);
        
        // é€šçŸ¥ç”¨æˆ·
        notificationService.notifyUser(order.getUserId(), "éª‘æ‰‹å·²åˆ°åº—å–é¤", order);
        
        return Result.success("çŠ¶æ€æ›´æ–°æˆåŠŸ");
    }
    
    /**
     * å·²å–é¤ï¼Œå¼€å§‹é…é€
     */
    private Result<String> handlePickedUp(UpdateStatusRequest request) {
        Order order = orderService.getById(request.getOrderId());
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus(OrderStatus.PICKED_UP.getCode());
        order.setPickupTime(new Date());
        orderService.updateById(order);
        
        // è‡ªåŠ¨è½¬ä¸ºé…é€ä¸­çŠ¶æ€
        order.setStatus(OrderStatus.DELIVERING.getCode());
        order.setDeliveryStartTime(new Date());
        orderService.updateById(order);
        
        // é€šçŸ¥ç”¨æˆ·å¼€å§‹é…é€
        notificationService.notifyUser(order.getUserId(), "éª‘æ‰‹å·²å–é¤ï¼Œæ­£åœ¨ä¸ºæ‚¨é…é€", order);
        
        // å¼€å¯å®æ—¶ä½ç½®è¿½è¸ª
        locationTrackingService.startTracking(request.getRiderId(), request.getOrderId());
        
        return Result.success("å¼€å§‹é…é€");
    }
    
    /**
     * é€è¾¾ç¡®è®¤
     */
    private Result<String> handleDelivered(UpdateStatusRequest request) {
        Order order = orderService.getById(request.getOrderId());
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus(OrderStatus.DELIVERED.getCode());
        order.setDeliveredTime(new Date());
        if (request.getLongitude() != null && request.getLatitude() != null) {
            order.setDeliveredLocation(request.getLongitude() + "," + request.getLatitude());
        }
        orderService.updateById(order);
        
        // æ›´æ–°éª‘æ‰‹çŠ¶æ€
        Rider rider = riderService.getById(request.getRiderId());
        rider.setCurrentOrdersCount(rider.getCurrentOrdersCount() - 1);
        riderService.updateById(rider);
        
        // åœæ­¢ä½ç½®è¿½è¸ª
        locationTrackingService.stopTracking(request.getRiderId(), request.getOrderId());
        
        // é€šçŸ¥ç”¨æˆ·ç¡®è®¤æ”¶è´§
        notificationService.notifyUser(order.getUserId(), "è®¢å•å·²é€è¾¾ï¼Œè¯·ç¡®è®¤æ”¶è´§", order);
        
        // è®¡ç®—éª‘æ‰‹æ”¶å…¥
        riderIncomeService.calculateIncome(request.getRiderId(), request.getOrderId());
        
        // 15åˆ†é’Ÿåè‡ªåŠ¨å®Œæˆè®¢å•
        delayedTaskService.scheduleOrderCompletion(request.getOrderId(), 15 * 60 * 1000);
        
        return Result.success("è®¢å•å·²é€è¾¾");
    }
}
```

### 5. å¾®ä¿¡å°ç¨‹åºä½ç½®è¿½è¸ª

#### éª‘æ‰‹ä½ç½®ä¸ŠæŠ¥æœºåˆ¶

```java
@RestController
@RequestMapping("/api/rider/location")
public class RiderLocationController {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Autowired
    private WeChatPushService weChatPushService;
    
    /**
     * éª‘æ‰‹å®šæ—¶ä¸ŠæŠ¥ä½ç½®
     */
    @PostMapping("/update")
    public Result<String> updateLocation(@RequestBody LocationUpdateRequest request) {
        // 1. æ ¡éªŒéª‘æ‰‹æƒé™
        if (!validateRiderPermission(request.getRiderId())) {
            return Result.fail("æƒé™éªŒè¯å¤±è´¥");
        }
        
        // 2. æ›´æ–°Redisä¸­çš„éª‘æ‰‹å®æ—¶ä½ç½®
        String locationKey = "rider:location:" + request.getRiderId();
        LocationInfo locationInfo = new LocationInfo();
        locationInfo.setLongitude(request.getLongitude());
        locationInfo.setLatitude(request.getLatitude());
        locationInfo.setUpdateTime(new Date());
        locationInfo.setAccuracy(request.getAccuracy());
        
        redisTemplate.opsForValue().set(locationKey, 
            JSON.toJSONString(locationInfo), Duration.ofMinutes(5));
        
        // 3. æ·»åŠ åˆ°åœ°ç†ä½ç½®ç´¢å¼•
        redisTemplate.opsForGeo().add("rider:locations", 
            new Point(request.getLongitude(), request.getLatitude()), 
            request.getRiderId().toString());
        
        // 4. æ¨é€ä½ç½®æ›´æ–°ç»™å…³æ³¨çš„ç”¨æˆ·ï¼ˆé€šè¿‡å¾®ä¿¡å°ç¨‹åºè®¢é˜…æ¶ˆæ¯ï¼‰
        List<Integer> trackingUsers = orderService.getUsersTrackingRider(request.getRiderId());
        for (Integer userId : trackingUsers) {
            weChatPushService.sendLocationUpdate(userId, locationInfo, request.getRiderId());
        }
        
        return Result.success("ä½ç½®æ›´æ–°æˆåŠŸ");
    }
    
    /**
     * ç”¨æˆ·æŸ¥è¯¢éª‘æ‰‹å®æ—¶ä½ç½®
     */
    @PostMapping("/query")
    public Result<LocationInfo> queryRiderLocation(@RequestBody LocationQueryRequest request) {
        // 1. æ ¡éªŒç”¨æˆ·æ˜¯å¦æœ‰æƒé™æŸ¥çœ‹è¯¥éª‘æ‰‹ä½ç½®
        if (!orderService.canUserTrackRider(request.getUserId(), request.getRiderId())) {
            return Result.fail("æ— æƒé™æŸ¥çœ‹è¯¥éª‘æ‰‹ä½ç½®");
        }
        
        // 2. ä»Redisè·å–éª‘æ‰‹æœ€æ–°ä½ç½®
        String locationKey = "rider:location:" + request.getRiderId();
        String locationStr = redisTemplate.opsForValue().get(locationKey);
        
        if (StringUtils.isEmpty(locationStr)) {
            return Result.fail("éª‘æ‰‹ä½ç½®ä¿¡æ¯ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ");
        }
        
        LocationInfo locationInfo = JSON.parseObject(locationStr, LocationInfo.class);
        
        // 3. è®¡ç®—é¢„è®¡åˆ°è¾¾æ—¶é—´
        if (request.getDestinationLng() != null && request.getDestinationLat() != null) {
            Integer estimatedTime = mapService.calculateETA(
                locationInfo.getLongitude(), locationInfo.getLatitude(),
                request.getDestinationLng(), request.getDestinationLat()
            );
            locationInfo.setEstimatedTime(estimatedTime);
        }
        
        return Result.success(locationInfo);
    }
}
```

#### å¾®ä¿¡å°ç¨‹åºç«¯ä½ç½®ä¸ŠæŠ¥

```javascript
// éª‘æ‰‹å°ç¨‹åº - å®šæ—¶ä¸ŠæŠ¥ä½ç½®
const LocationReporter = {
  timer: null,
  
  // å¼€å§‹ä½ç½®ä¸ŠæŠ¥
  startReporting() {
    this.timer = setInterval(() => {
      this.reportLocation();
    }, 10000); // æ¯10ç§’ä¸ŠæŠ¥ä¸€æ¬¡ä½ç½®
  },
  
  // ä¸ŠæŠ¥ä½ç½®
  reportLocation() {
    wx.getLocation({
      type: 'gcj02',
      success: (res) => {
        wx.request({
          url: 'https://api.example.com/api/rider/location/update',
          method: 'POST',
          data: {
            riderId: wx.getStorageSync('riderId'),
            longitude: res.longitude,
            latitude: res.latitude,
            accuracy: res.accuracy,
            timestamp: Date.now()
          },
          success: (result) => {
            console.log('ä½ç½®ä¸ŠæŠ¥æˆåŠŸ', result);
          },
          fail: (error) => {
            console.error('ä½ç½®ä¸ŠæŠ¥å¤±è´¥', error);
          }
        });
      },
      fail: (error) => {
        console.error('è·å–ä½ç½®å¤±è´¥', error);
      }
    });
  },
  
  // åœæ­¢ä½ç½®ä¸ŠæŠ¥
  stopReporting() {
    if (this.timer) {
      clearInterval(this.timer);
      this.timer = null;
    }
  }
};

// ç”¨æˆ·å°ç¨‹åº - è½®è¯¢æŸ¥è¯¢éª‘æ‰‹ä½ç½®
const LocationTracker = {
  timer: null,
  
  // å¼€å§‹è¿½è¸ªéª‘æ‰‹ä½ç½®
  startTracking(riderId) {
    this.timer = setInterval(() => {
      this.queryRiderLocation(riderId);
    }, 5000); // æ¯5ç§’æŸ¥è¯¢ä¸€æ¬¡éª‘æ‰‹ä½ç½®
  },
  
  // æŸ¥è¯¢éª‘æ‰‹ä½ç½®
  queryRiderLocation(riderId) {
    wx.request({
      url: 'https://api.example.com/api/rider/location/query',
      method: 'POST',
      data: {
        userId: wx.getStorageSync('userId'),
        riderId: riderId,
        destinationLng: this.data.deliveryLng,
        destinationLat: this.data.deliveryLat
      },
      success: (res) => {
        if (res.data.success) {
          // æ›´æ–°åœ°å›¾ä¸Šçš„éª‘æ‰‹ä½ç½®
          this.updateRiderMarker(res.data.data);
          // æ›´æ–°é¢„è®¡åˆ°è¾¾æ—¶é—´
          this.updateETA(res.data.data.estimatedTime);
        }
      }
    });
  },
  
  // åœæ­¢è¿½è¸ª
  stopTracking() {
    if (this.timer) {
      clearInterval(this.timer);
      this.timer = null;
    }
  }
};
```

#### å¾®ä¿¡æ¨é€æœåŠ¡å®ç°

```java
@Service
public class WeChatPushService {
    
    @Autowired
    private WeChatApiService weChatApiService;
    
    /**
     * å‘é€è®¢å•æŠ¢å•æˆåŠŸé€šçŸ¥
     */
    public void sendOrderGrabNotification(Integer riderId, Order order) {
        try {
            Rider rider = riderService.getById(riderId);
            if (rider == null || StringUtils.isEmpty(rider.getOpenId())) {
                return;
            }
            
            // æ„å»ºæ¨¡æ¿æ¶ˆæ¯
            Map<String, Object> data = new HashMap<>();
            data.put("keyword1", new TemplateData(order.getOrderNo()));
            data.put("keyword2", new TemplateData(order.getShopName()));
            data.put("keyword3", new TemplateData(order.getDeliveryFee() + "å…ƒ"));
            data.put("keyword4", new TemplateData("è¯·å°½å¿«å‰å¾€å•†å®¶å–é¤"));
            
            TemplateMessage message = new TemplateMessage();
            message.setTouser(rider.getOpenId());
            message.setTemplate_id("ORDER_GRAB_SUCCESS_TEMPLATE_ID");
            message.setData(data);
            message.setMiniprogram(new MiniProgram("your-miniprogram-appid", 
                "pages/order/detail?orderId=" + order.getId()));
            
            weChatApiService.sendTemplateMessage(message);
            
        } catch (Exception e) {
            log.error("å‘é€æŠ¢å•æˆåŠŸé€šçŸ¥å¤±è´¥", e);
        }
    }
    
    /**
     * å‘é€é…é€çŠ¶æ€æ›´æ–°é€šçŸ¥ç»™ç”¨æˆ·
     */
    public void sendDeliveryStatusUpdate(Integer userId, String status, Order order) {
        try {
            User user = userService.getById(userId);
            if (user == null || StringUtils.isEmpty(user.getOpenId())) {
                return;
            }
            
            String statusText = getStatusText(status);
            
            Map<String, Object> data = new HashMap<>();
            data.put("keyword1", new TemplateData(order.getOrderNo()));
            data.put("keyword2", new TemplateData(statusText));
            data.put("keyword3", new TemplateData(new Date()));
            data.put("keyword4", new TemplateData("ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…"));
            
            TemplateMessage message = new TemplateMessage();
            message.setTouser(user.getOpenId());
            message.setTemplate_id("DELIVERY_STATUS_UPDATE_TEMPLATE_ID");
            message.setData(data);
            message.setMiniprogram(new MiniProgram("your-user-miniprogram-appid", 
                "pages/order/tracking?orderId=" + order.getId()));
            
            weChatApiService.sendTemplateMessage(message);
            
        } catch (Exception e) {
            log.error("å‘é€é…é€çŠ¶æ€æ›´æ–°é€šçŸ¥å¤±è´¥", e);
        }
    }
    
    private String getStatusText(String status) {
        switch (status) {
            case "RIDER_ARRIVED": return "éª‘æ‰‹å·²åˆ°åº—";
            case "PICKED_UP": return "éª‘æ‰‹å·²å–é¤";
            case "DELIVERING": return "æ­£åœ¨é…é€ä¸­";
            case "DELIVERED": return "è®¢å•å·²é€è¾¾";
            default: return "çŠ¶æ€å·²æ›´æ–°";
        }
    }
}
```

### 6. éª‘æ‰‹ç«¯è¯¦ç»†æ“ä½œæµç¨‹

#### éª‘æ‰‹å·¥ä½œå°é¡µé¢æµç¨‹

```mermaid
graph TD
    A[éª‘æ‰‹ç™»å½•] --> B[è·å–å½“å‰ä½ç½®]
    B --> C[è¿›å…¥å·¥ä½œå°]
    C --> D{å½“å‰çŠ¶æ€}
    
    D -->|ç©ºé—²| E[æŸ¥çœ‹é™„è¿‘è®¢å•]
    D -->|é…é€ä¸­| F[æŸ¥çœ‹å½“å‰é…é€ä»»åŠ¡]
    D -->|ä¼‘æ¯| G[ä¼‘æ¯æ¨¡å¼é¡µé¢]
    
    E --> H[è®¢å•åˆ—è¡¨å±•ç¤º]
    H --> I[é€‰æ‹©è®¢å•æŸ¥çœ‹è¯¦æƒ…]
    I --> J[ç‚¹å‡»æŠ¢å•]
    J --> K{æŠ¢å•ç»“æœ}
    
    K -->|æˆåŠŸ| L[è·³è½¬åˆ°é…é€ä»»åŠ¡é¡µ]
    K -->|å¤±è´¥| M[æ˜¾ç¤ºå¤±è´¥åŸå› ]
    M --> E
    
    F --> N[æŸ¥çœ‹é…é€è¿›åº¦]
    N --> O[æ›´æ–°é…é€çŠ¶æ€]
    O --> P{æ˜¯å¦è¿˜æœ‰é…é€ä»»åŠ¡}
    
    P -->|æœ‰| F
    P -->|æ— | E
    
    G --> Q[åˆ‡æ¢åˆ°å·¥ä½œçŠ¶æ€]
    Q --> E
```

#### é…é€ä»»åŠ¡æ‰§è¡Œæµç¨‹

```mermaid
graph TD
    A[æ¥åˆ°æ–°è®¢å•] --> B[æŸ¥çœ‹è®¢å•è¯¦æƒ…]
    B --> C[è§„åˆ’å–é¤è·¯çº¿]
    C --> D[å‰å¾€å•†å®¶]
    D --> E[åˆ°è¾¾å•†å®¶]
    E --> F[ç‚¹å‡»å·²åˆ°åº—]
    
    F --> G[ç­‰å¾…å•†å®¶å‡†å¤‡]
    G --> H[å•†å“å‡†å¤‡å®Œæˆ]
    H --> I[æ ¸å¯¹å•†å“ä¿¡æ¯]
    I --> J[ç‚¹å‡»å·²å–é¤]
    
    J --> K[è§„åˆ’é…é€è·¯çº¿]
    K --> L[å‰å¾€é…é€åœ°å€]
    L --> M[å®æ—¶ä½ç½®ä¸ŠæŠ¥]
    M --> N[åˆ°è¾¾é…é€åœ°å€]
    N --> O[è”ç³»æ”¶è´§äºº]
    
    O --> P{é…é€æ–¹å¼}
    P -->|é€ä¸Šé—¨| Q[é€åˆ°æŒ‡å®šä½ç½®]
    P -->|ç”¨æˆ·ä¸‹æ¥¼å–| R[åœ¨æ¥¼ä¸‹ç­‰å¾…]
    
    Q --> S[ç¡®è®¤æ”¶è´§]
    R --> S
    S --> T[ç‚¹å‡»å·²é€è¾¾]
    T --> U[ä¸Šä¼ é€è¾¾ç…§ç‰‡/è·å–ç¡®è®¤ç ]
    U --> V[å®Œæˆé…é€]
    V --> W[ç³»ç»Ÿç»“ç®—æ”¶å…¥]
```

#### å¤šè®¢å•å¹¶è¡Œé…é€æµç¨‹

```mermaid
graph TD
    A[éª‘æ‰‹æ¥åˆ°å¤šä¸ªè®¢å•] --> B[æ™ºèƒ½è·¯å¾„è§„åˆ’]
    B --> C[æŒ‰æœ€ä¼˜è·¯çº¿æ’åº]
    C --> D[ç¬¬ä¸€å®¶å•†å®¶å–é¤]
    D --> E[ç¬¬äºŒå®¶å•†å®¶å–é¤]
    E --> F[ç¬¬ä¸‰å®¶å•†å®¶å–é¤]
    
    F --> G[æŒ‰é…é€ä¼˜å…ˆçº§æ’åº]
    G --> H{é…é€ç­–ç•¥}
    
    H -->|è·ç¦»ä¼˜å…ˆ| I[æŒ‰è·ç¦»è¿œè¿‘é…é€]
    H -->|æ—¶é—´ä¼˜å…ˆ| J[æŒ‰ä¸‹å•æ—¶é—´é…é€]
    H -->|ä»·å€¼ä¼˜å…ˆ| K[æŒ‰é…é€è´¹é«˜ä½é…é€]
    
    I --> L[é…é€ç¬¬ä¸€å•]
    J --> L
    K --> L
    
    L --> M[æ›´æ–°GPSä½ç½®]
    M --> N[é€è¾¾ç¡®è®¤]
    N --> O{è¿˜æœ‰å¾…é…é€è®¢å•?}
    
    O -->|æ˜¯| P[å‰å¾€ä¸‹ä¸€ä¸ªé…é€ç‚¹]
    O -->|å¦| Q[å…¨éƒ¨é…é€å®Œæˆ]
    
    P --> M
    Q --> R[å›åˆ°ç©ºé—²çŠ¶æ€]
```

### 7. æ”¶å…¥ç»“ç®—ç³»ç»Ÿè¯¦ç»†è®¾è®¡

#### æ”¶å…¥è®¡ç®—è§„åˆ™

```mermaid
graph TD
    A[è®¢å•é€è¾¾å®Œæˆ] --> B[è§¦å‘æ”¶å…¥è®¡ç®—]
    B --> C[è·å–è®¢å•åŸºç¡€ä¿¡æ¯]
    C --> D[è®¡ç®—åŸºç¡€é…é€è´¹]
    D --> E[è®¡ç®—è·ç¦»è¡¥è´´]
    E --> F[è®¡ç®—æ—¶é—´è¡¥è´´]
    F --> G[è®¡ç®—æ¶åŠ£å¤©æ°”è¡¥è´´]
    G --> H[è®¡ç®—å¤œé—´é…é€è¡¥è´´]
    H --> I[è®¡ç®—å¥½è¯„å¥–åŠ±]
    I --> J[æ‰£é™¤å¹³å°æœåŠ¡è´¹]
    J --> K[è®¡ç®—æœ€ç»ˆæ”¶å…¥]
    K --> L[è®°å½•æ”¶å…¥æ˜ç»†]
    L --> M[æ›´æ–°éª‘æ‰‹è´¦æˆ·ä½™é¢]
```

#### æ”¶å…¥ç»“ç®—å…¬å¼

```
éª‘æ‰‹å®é™…æ”¶å…¥ = åŸºç¡€é…é€è´¹ + è·ç¦»è¡¥è´´ + æ—¶é—´è¡¥è´´ + å¤©æ°”è¡¥è´´ + å¤œé—´è¡¥è´´ + å¥½è¯„å¥–åŠ± - å¹³å°æœåŠ¡è´¹

å…¶ä¸­ï¼š
- å•†æˆ·æŠ½æˆæ¯”ä¾‹ï¼šæŒ‰å•†æˆ·å•ç‹¬é…ç½®ï¼ˆä¾‹å¦‚å•†å®¶1=20%ï¼‰ï¼Œåœ¨è®¢å•åˆ›å»ºæ—¶é”å®šå…¥åº“ï¼›
- åŸºç¡€é…é€è´¹ = è®¢å•é…é€è´¹ Ã— (1 - é…é€æŠ½æˆæ¯”ä¾‹)
- å¹³å°å•†å“æŠ½æˆ = å•†å“å®ä»˜ Ã— å•†æˆ·æŠ½æˆæ¯”ä¾‹
- å¹³å°é…é€æŠ½æˆ = é…é€è´¹ Ã— é…é€æŠ½æˆæ¯”ä¾‹
```

### 8. å¼‚å¸¸å¤„ç†æœºåˆ¶

#### è®¢å•å¼‚å¸¸å¤„ç†æµç¨‹

```mermaid
graph TD
    A[é…é€è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸] --> B{å¼‚å¸¸ç±»å‹}
    
    B -->|å•†å®¶å‡ºé¤å»¶è¿Ÿ| C[é€šçŸ¥ç”¨æˆ·å»¶è¿ŸåŸå› ]
    B -->|éª‘æ‰‹è½¦è¾†æ•…éšœ| D[ç³»ç»Ÿé‡æ–°æ´¾å•]
    B -->|ç”¨æˆ·ä¸´æ—¶æ”¹åœ°å€| E[é‡æ–°è®¡ç®—é…é€è´¹]
    B -->|ç”¨æˆ·ä¸æ¥ç”µè¯| F[å°è¯•å¤šæ¬¡è”ç³»]
    B -->|å•†å“æ´’æ¼æŸå| G[å•†å®¶é‡åšæˆ–é€€æ¬¾]
    B -->|æ¶åŠ£å¤©æ°”| H[æš‚åœæ´¾å•æˆ–å¢åŠ è¡¥è´´]
    
    C --> I[æ›´æ–°é¢„è®¡é€è¾¾æ—¶é—´]
    D --> J[é€šçŸ¥å…¶ä»–éª‘æ‰‹æŠ¢å•]
    E --> K[ç”¨æˆ·ç¡®è®¤åç»§ç»­é…é€]
    F --> L{è”ç³»ç»“æœ}
    G --> M[æŸå¤±è´£ä»»è®¤å®š]
    H --> N[é£é™©è¯„ä¼°]
    
    L -->|è”ç³»ä¸Š| O[æ­£å¸¸å®Œæˆé…é€]
    L -->|è”ç³»ä¸ä¸Š| P[æ”¾ç½®åœ¨æŒ‡å®šä½ç½®å¹¶æ‹ç…§]
    
    I --> O
    J --> Q[æ–°éª‘æ‰‹æ¥æ‰‹é…é€]
    K --> O
    M --> R[ä¿é™©ç†èµ”æˆ–è´£ä»»æ‰¿æ‹…]
    N --> S[æ¢å¤æ­£å¸¸è¿è¥]
    O --> T[è®¢å•æ­£å¸¸å®Œæˆ]
    P --> U[24å°æ—¶åè‡ªåŠ¨ç¡®è®¤æ”¶è´§]
    Q --> T
    R --> T
    S --> T
    U --> T
```

### 9. ç³»ç»Ÿç›‘æ§å’Œæ•°æ®åˆ†æ

#### å…³é”®æŒ‡æ ‡ç›‘æ§

```mermaid
graph LR
    A[éª‘æ‰‹ç«¯æ•°æ®é‡‡é›†] --> B[å®æ—¶ç›‘æ§å¹³å°]
    
    B --> C[é…é€æ•ˆç‡æŒ‡æ ‡]
    B --> D[æœåŠ¡è´¨é‡æŒ‡æ ‡]
    B --> E[æ”¶å…¥åˆ†ææŒ‡æ ‡]
    B --> F[å¼‚å¸¸ç›‘æ§æŒ‡æ ‡]
    
    C --> C1[å¹³å‡é…é€æ—¶é•¿]
    C --> C2[è®¢å•å®Œæˆç‡]
    C --> C3[å‡†ç‚¹ç‡]
    
    D --> D1[ç”¨æˆ·è¯„åˆ†]
    D --> D2[æŠ•è¯‰ç‡]
    D --> D3[å¥½è¯„ç‡]
    
    E --> E1[æ—¥å‡æ”¶å…¥]
    E --> E2[å•å‡æ”¶å…¥]
    E --> E3[æ”¶å…¥å¢é•¿è¶‹åŠ¿]
    
    F --> F1[è¶…æ—¶è®¢å•]
    F --> F2[å–æ¶ˆè®¢å•]
    F --> F3[å®¢è¯‰è®¢å•]
```

### 10. æŠ€æœ¯å®ç°è¦ç‚¹

#### å…³é”®æŠ€æœ¯é€‰å‹

| æŠ€æœ¯ç»„ä»¶ | é€‰å‹æ–¹æ¡ˆ | ç”¨é€”è¯´æ˜ |
|---------|---------|----------|
| ä½ç½®æœåŠ¡ | è…¾è®¯åœ°å›¾API | åœ°ç†å®šä½ã€è·ç¦»è®¡ç®—ã€è·¯å¾„è§„åˆ’ |
| å®æ—¶é€šä¿¡ | è½®è¯¢ + å¾®ä¿¡æ¨é€ | è®¢å•æ¨é€ã€çŠ¶æ€æ›´æ–° |
| åˆ†å¸ƒå¼é” | Redis + Redisson | é˜²æ­¢è®¢å•é‡å¤æŠ¢å  |
| æ¶ˆæ¯é˜Ÿåˆ— | RocketMQ | å¼‚æ­¥å¤„ç†ã€å‰Šå³°å¡«è°· |
| æ•°æ®åº“ | MySQL + Redis | å…³ç³»æ•°æ®å­˜å‚¨ + ç¼“å­˜ |
| æœç´¢å¼•æ“ | Elasticsearch | åœ°ç†ä½ç½®æœç´¢ä¼˜åŒ– |
| ç›‘æ§ç³»ç»Ÿ | Prometheus + Grafana | æ€§èƒ½ç›‘æ§ã€æ•°æ®å±•ç¤º |

#### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **åœ°ç†ä½ç½®æŸ¥è¯¢ä¼˜åŒ–**
   - ä½¿ç”¨GeoHashç®—æ³•æé«˜æŸ¥è¯¢æ•ˆç‡
   - Redis Geoæ•°æ®ç»“æ„å­˜å‚¨å®æ—¶ä½ç½®
   - å»ºç«‹åˆé€‚çš„æ•°æ®åº“ç©ºé—´ç´¢å¼•

2. **è®¢å•æ¨é€ä¼˜åŒ–**
   - åŸºäºéª‘æ‰‹ä½ç½®çš„æ™ºèƒ½æ¨é€
   - å¾®ä¿¡æ¨é€æœåŠ¡ç®¡ç†å’Œé™é¢‘
   - è½®è¯¢é¢‘ç‡ä¼˜åŒ–å’Œæ¶ˆæ¯å»é‡

3. **å¹¶å‘æ§åˆ¶ä¼˜åŒ–**
   - åˆ†å¸ƒå¼é”çš„è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
   - æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
   - ç¼“å­˜ç©¿é€å’Œé›ªå´©é˜²æŠ¤

## æ€»ç»“

è¿™ä¸ªè´¡äº«è‡»é€‰2.0éª‘æ‰‹æŠ¢å•é…é€ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆåŒ…å«äº†ï¼š

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
1. **æ™ºèƒ½æŠ¢å•æœºåˆ¶**ï¼šåŸºäºåœ°ç†ä½ç½®çš„è®¢å•æ¨èå’Œåˆ†å¸ƒå¼æŠ¢å•
2. **å®Œæ•´é…é€æµç¨‹**ï¼šä»æ¥å•åˆ°é€è¾¾çš„å…¨çŠ¶æ€ç®¡ç†
3. **ä½ç½®è¿½è¸ª**ï¼šç”¨æˆ·å¯é€šè¿‡è½®è¯¢æŸ¥çœ‹é…é€è¿›åº¦
4. **æ”¶å…¥ç»“ç®—ç³»ç»Ÿ**ï¼šå…¬å¹³é€æ˜çš„æ”¶å…¥åˆ†é…æœºåˆ¶
5. **å¼‚å¸¸å¤„ç†æœºåˆ¶**ï¼šå®Œå–„çš„å¼‚å¸¸æƒ…å†µå¤„ç†æµç¨‹

### æŠ€æœ¯ç‰¹è‰²
1. **å¾®ä¿¡ç”Ÿæ€**ï¼šå®Œå…¨åŸºäºå¾®ä¿¡å°ç¨‹åºï¼Œæ— éœ€é¢å¤–APP
2. **é«˜æ€§èƒ½**ï¼šåˆ†å¸ƒå¼æ¶æ„ï¼Œæ”¯æŒå¤§å¹¶å‘
3. **é«˜å¯ç”¨**ï¼šå¼‚å¸¸å®¹é”™ï¼ŒæœåŠ¡é™çº§
4. **æ™ºèƒ½åŒ–**ï¼šAIè·¯å¾„è§„åˆ’ï¼Œæ™ºèƒ½æ¨è
5. **æ¨é€åŠæ—¶**ï¼šå¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ä¿è¯é€šçŸ¥åˆ°è¾¾

### ä¸šåŠ¡ä»·å€¼
1. **æå‡æ•ˆç‡**ï¼šå‡å°‘ç©ºè·‘æ—¶é—´ï¼Œæé«˜é…é€æ•ˆç‡
2. **å¢åŠ æ”¶å…¥**ï¼šåˆç†çš„æ¿€åŠ±æœºåˆ¶ï¼Œæå‡éª‘æ‰‹ç§¯ææ€§
3. **ä¼˜åŒ–ä½“éªŒ**ï¼šå®æ—¶é€æ˜ï¼Œæå‡ç”¨æˆ·æ»¡æ„åº¦
4. **é™ä½æˆæœ¬**ï¼šæ™ºèƒ½è°ƒåº¦ï¼Œé™ä½è¿è¥æˆæœ¬

è¯¥è®¾è®¡æ–¹æ¡ˆå‚è€ƒäº†ç¾å›¢ã€é¥¿äº†ä¹ˆç­‰ä¸»æµå¤–å–å¹³å°çš„æˆç†Ÿç»éªŒï¼Œç»“åˆè´¡äº«è‡»é€‰2.0é¡¹ç›®çš„å…·ä½“éœ€æ±‚ï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´å¯è¡Œçš„æŠ€æœ¯è§£å†³æ–¹æ¡ˆã€‚

