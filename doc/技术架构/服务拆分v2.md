# 外卖平台微服务拆分方案 - 服务边界设计

## 核心原则：高内聚、低耦合

**设计原则**：
- 每个服务管理自己的完整业务闭环
- 减少服务间的实时调用，优先使用事件驱动
- 数据ownership清晰，避免跨服务的数据依赖
- 按业务能力拆分，而非技术层面拆分

---

## 服务拆分详解（共8个核心服务）

### 🔗 1. `gateway-service` - 网关服务
**端口**: 8080  
**核心关注**: 统一入口控制  
**职责边界**:
- 路由分发到后端服务
- 统一鉴权（JWT验证）
- 限流熔断保护
- 日志记录

**不关心**: 任何业务逻辑  
**对外暴露**: 统一API入口  
**依赖服务**: 无（直接路由）

---

### 👤 2. `user-service` - 用户服务
**端口**: 8081  
**核心关注**: 用户账户的完整生命周期  
**职责边界**:
- **用户身份管理**: 注册、登录、微信授权
- **用户信息管理**: 昵称、头像、手机号、认证状态
- **地址管理**: 收货地址的增删改查、默认地址、坐标转换
- **用户状态管理**: 正常/冻结/黑名单

**数据ownership**:
- 用户基础信息
- 用户地址信息
- 用户登录态

**不关心**:
- 用户的订单信息（属于订单服务）
- 用户的余额信息（属于钱包服务）

**典型API**:
```
POST /api/user/login         # 微信登录
GET  /api/user/profile       # 用户信息  
POST /api/user/address       # 新增地址
GET  /api/user/addresses     # 地址列表
```

**对外提供数据**: 通过API提供用户基础信息给其他服务

---

### 🏪 3. `merchant-service` - 商户商品服务
**端口**: 8082  
**核心关注**: 商户和商品的完整管理  
**职责边界**:
- **商户管理**: 入驻、资质审核、店铺信息、营业状态
- **商品管理**: 外卖菜品、平台自营商品、团购商品
- **库存管理**: 商品库存、规格管理、上下架
- **商户配置**: 营业时间、配送范围、配送费规则

**为什么合并**: 商品和商户强耦合，商品必须属于某个商户，分开会导致频繁跨服务调用

**数据ownership**:
- 商户基础信息
- 商品信息（所有类型）
- 商品库存
- 商户配置规则

**典型API**:
```
# 商户相关
POST /api/merchant/register  # 商户入驻
PUT  /api/merchant/status    # 营业状态
GET  /api/merchant/nearby    # 附近商户

# 商品相关  
POST /api/goods/create       # 创建商品
GET  /api/goods/list         # 商品列表
PUT  /api/goods/stock        # 更新库存
POST /api/goods/check-stock  # 库存校验（内部调用）
```

**减少外部调用**: 内部完成商户商品的所有逻辑，对外提供聚合数据

---

### 💰 4. `order-service` - 订单交易服务
**端口**: 8083  
**核心关注**: 订单的完整生命周期  
**职责边界**:
- **订单创建**: 外卖订单、团购订单、采购订单
- **订单状态管理**: 完整的状态流转
- **价格计算**: 商品价格、配送费、优惠抵扣、最终支付金额
- **支付管理**: 微信支付调用、支付回调处理、退款处理
- **订单查询**: 多维度订单查询、订单详情

**为什么包含支付**: 支付和订单强绑定，分离会导致状态同步复杂

**数据ownership**:
- 订单完整信息
- 支付记录
- 退款记录
- 订单状态变更记录

**外部数据获取**:
- 调用user-service获取用户地址（下单时）
- 调用merchant-service校验商品和库存（下单时）
- 通过事件通知delivery-service有新订单

**典型API**:
```
POST /api/order/create       # 创建订单（含价格计算）
GET  /api/order/detail/{id}  # 订单详情
PUT  /api/order/cancel/{id}  # 取消订单
POST /api/order/pay          # 发起支付
POST /api/order/pay/callback # 支付回调
GET  /api/order/list         # 订单列表
```

**减少外部调用策略**:
- 下单时一次性获取并缓存用户地址、商品信息
- 支付成功后通过MQ异步通知其他服务

---

### 🚚 5. `delivery-service` - 配送履约服务
**端口**: 8084  
**核心关注**: 配送的完整履约过程  
**职责边界**:
- **骑手管理**: 注册认证、基本信息、工作状态、评级
- **配送调度**: 订单分配、抢单逻辑、配送路径优化
- **配送跟踪**: 实时位置、配送状态、异常处理
- **配送结算**: 配送费计算、骑手收入、结算周期
- **服务评价**: 用户对骑手评价、骑手服务质量

**数据ownership**:
- 骑手完整信息
- 配送任务信息
- 位置轨迹数据
- 配送费用规则
- 骑手收入记录

**外部数据获取**:
- 监听order-service的订单事件（新订单、订单取消）
- 配送完成后通知order-service更新订单状态

**典型API**:
```
# 骑手管理
POST /api/delivery/rider/register  # 骑手注册
PUT  /api/delivery/rider/status    # 更新状态
POST /api/delivery/location        # 位置上报

# 配送管理
GET  /api/delivery/nearby-orders   # 待抢订单
POST /api/delivery/grab            # 抢单
PUT  /api/delivery/status          # 更新配送状态
GET  /api/delivery/earnings        # 收入明细
```

**减少外部调用**:
- 通过MQ事件获得订单信息，避免实时调用
- 配送状态变更通过MQ异步通知订单服务

---

### 🎯 6. `promotion-service` - 营销促销服务
**端口**: 8085  
**核心关注**: 营销活动的完整闭环  
**职责边界**:
- **优惠券系统**: 券模板、发放、领取、核销
- **促销活动**: 满减、折扣、限时活动
- **价格计算引擎**: 优惠匹配、价格试算、最优方案
- **营销数据**: 活动效果、券使用情况

**数据ownership**:
- 优惠券模板和实例
- 促销活动配置
- 优惠券使用记录
- 价格计算规则

**外部调用**:
- 被order-service调用进行价格计算
- 订单支付成功后核销优惠券

**典型API**:
```
POST /api/promo/coupon/create    # 创建优惠券
GET  /api/promo/coupon/my        # 我的优惠券
POST /api/promo/calc-price       # 价格计算（核心接口）
POST /api/promo/coupon/lock      # 锁定优惠券
POST /api/promo/coupon/use       # 使用优惠券
```

**服务边界要点**:
- 所有价格相关计算都在这里完成
- order-service不关心优惠逻辑，只调用计算接口

---

### 💳 7. `wallet-service` - 钱包财务服务
**端口**: 8086  
**核心关注**: 资金账户的完整管理  
**职责边界**:
- **账户管理**: 用户余额、商户收入、骑手收入
- **资金流转**: 充值、提现、转账、冻结解冻
- **交易记录**: 完整的资金流水记录
- **结算管理**: 商户结算、骑手结算、平台分账
- **财务报表**: 收支统计、利润分析

**数据ownership**:
- 所有账户余额信息
- 资金变动流水
- 结算记录
- 财务报表数据

**外部数据获取**:
- 监听order-service的支付成功事件
- 监听delivery-service的配送完成事件

**典型API**:
```
GET  /api/wallet/balance         # 查询余额
POST /api/wallet/recharge        # 充值
POST /api/wallet/withdraw        # 提现
GET  /api/wallet/transactions    # 交易流水
POST /api/wallet/settle          # 结算处理
```

**减少外部调用**:
- 通过MQ事件驱动资金变动，避免实时调用
- 内部完成所有资金计算逻辑

---

### 🛠️ 8. `admin-service` - 运营管理服务
**端口**: 8087  
**核心关注**: 平台运营管理  
**职责边界**:
- **权限管理**: 管理员账号、角色权限、操作日志
- **内容管理**: 公告、轮播图、帮助文档、团购内容
- **数据统计**: 业务大盘、报表生成、数据分析
- **系统配置**: 参数配置、规则配置、开关控制
- **审核工具**: 商户审核、内容审核、投诉处理

**数据ownership**:
- 管理员权限数据
- CMS内容数据
- 系统配置数据
- 统计分析数据

**外部数据获取**:
- 从各个服务获取统计数据（通过API调用）
- 对其他服务的数据进行审核操作

**典型API**:
```
POST /api/admin/login           # 管理员登录
GET  /api/admin/dashboard       # 数据大盘
GET  /api/admin/statistics      # 统计数据
POST /api/admin/audit           # 审核操作
GET  /api/admin/config          # 系统配置
```

---

## 服务间交互设计

### 🔄 调用关系最小化原则

#### 同步调用（必须实时的）
```
网关 → 各服务 (路由)
订单服务 → 用户服务 (获取地址信息)
订单服务 → 商户服务 (校验商品库存)  
订单服务 → 营销服务 (价格计算)
管理服务 → 各服务 (统计查询)
```

#### 异步事件（可以延迟的）
```
订单支付成功 → MQ → 配送服务 (新配送任务)
订单支付成功 → MQ → 钱包服务 (资金变动)
配送完成 → MQ → 订单服务 (更新订单状态)
配送完成 → MQ → 钱包服务 (骑手结算)
```

### 🎯 数据边界清晰

每个服务只管理自己的数据：
- **用户服务**: 用户信息、地址信息
- **商户服务**: 商户信息、商品信息、库存信息
- **订单服务**: 订单信息、支付信息
- **配送服务**: 骑手信息、配送信息
- **营销服务**: 优惠券信息、活动信息
- **钱包服务**: 账户信息、资金流水
- **管理服务**: 权限信息、配置信息

### 🚀 性能优化策略

1. **减少实时调用**: 通过MQ事件驱动，异步处理非实时需求
2. **数据冗余**: 在订单中冗余必要的用户、商品快照，减少查询
3. **缓存策略**: 热点数据缓存在Redis中
4. **批量处理**: 结算、统计等通过批量任务处理

---

## 总结

这个8服务的拆分方案：
- **边界清晰**: 每个服务有明确的数据ownership
- **低耦合**: 服务间通过事件驱动异步交互
- **高内聚**: 相关功能聚合在一个服务内
- **易扩展**: 每个服务可以独立扩展和部署

相比之前11个服务的方案，这个方案减少了服务数量，降低了服务间的通信复杂度，更适合中小规模的外卖平台。
