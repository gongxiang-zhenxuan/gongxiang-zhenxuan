# 贡享臻选2.0外卖系统技术方案 - MVP版本

## 1. 项目目标与范围

### 业务目标
实现一个**微信小程序端**的外卖平台MVP，支持用户点餐、商户接单、骑手抢单配送、支付结算的完整闭环。

### MVP功能边界
✅ **包含功能**：
- 用户注册登录、地址管理
- 商户入驻、商品管理
- 下单支付（微信支付）
- 骑手抢单配送
- 基础收入结算
- 订单状态追踪

❌ **暂不包含**：
- 发布灰度、容灾备份
- 安全合规、监控运维  
- 营销活动、团购电商
- 复杂的数据分析和报表

### 容量目标
- 日订单量：1000-5000单
- 并发用户：100-500人
- 响应时间：<2s
- 可用性：99%+

## 2. 技术架构设计

### 2.1 整体架构图

```mermaid
graph LR
    %% 终端层
    subgraph 终端
        A1[用户小程序]
        A2[骑手小程序]
        A3[商户小程序]
        A4[管理后台]
    end

    %% 网关层
    subgraph 网关层
        B[Spring Cloud Gateway]
    end

    %% 微服务层
    subgraph 微服务层
        C1[用户服务]
        C2[商户服务]
        C3[商品服务]
        C4[订单服务]
        C5[支付服务]
        C6[骑手服务]
        C7[配送服务]
        C8[通知服务]
        C9[团购服务]
        C10[物流服务]
        C11[营销服务]
    end

    %% 数据层
    subgraph 数据层
        D1[(MySQL)]
        D2[(Redis)]
    end

    %% 第三方服务（按MVP使用最少外部依赖）
    subgraph 第三方服务
        E1[微信支付]
        E2[腾讯地图]
        E3[快递物流API]
    end

    %% 终端到网关
    A1 --> B
    A2 --> B
    A3 --> B
    A4 --> B

    %% 网关到微服务（扇出）
    B --> C1
    B --> C2
    B --> C3
    B --> C4
    B --> C5
    B --> C6
    B --> C7
    B --> C8
    B --> C9
    B --> C10
    B --> C11

    %% 微服务到数据层（统一收敛，避免线条杂乱）
    C1 --> D1
    C2 --> D1
    C3 --> D1
    C4 --> D1
    C5 --> D1
    C6 --> D1
    C7 --> D1
    C8 --> D1
    C9 --> D1
    C10 --> D1
    C11 --> D1

    C1 --> D2
    C2 --> D2
    C3 --> D2
    C4 --> D2
    C5 --> D2
    C6 --> D2
    C7 --> D2
    C8 --> D2
    C9 --> D2
    C10 --> D2
    C11 --> D2

    %% 微服务到第三方（仅必要依赖）
    C5 --> E1
    C7 --> E2
    C10 --> E3
```

### 2.2 技术选型

| 组件类型 | 技术选型 | 说明 |
|---------|---------|------|
| 前端 | 微信小程序 | 用户端、骑手端、商户端 |
| API网关 | Spring Cloud Gateway | 统一入口、鉴权、限流 |
| 微服务框架 | Spring Boot 2.7 | 快速开发，成熟稳定 |
| 服务调用 | HTTP/REST | 简化架构，避免RPC复杂性 |
| 服务发现 | Nacos 注册中心 | Spring Cloud Alibaba Nacos Discovery，服务名调用 + 负载均衡 |
| 配置中心 | Nacos Config | 统一配置管理，按环境/命名空间隔离 |
| 数据库 | MySQL 8.0 | 单库架构，主从部署 |
| 缓存 | Redis 7.0 | 会话、热点数据缓存 |
| 消息队列 | RocketMQ | 异步处理、削峰填谷 |
| 支付 | 微信支付 | 小程序原生支持 |
| 地图服务 | 腾讯地图API | 位置、距离、路径规划 |
| 快递查询 | 阿里云市场API | B2B订单物流轨迹查询 |
| 部署 | Docker + Nginx | 容器化部署 |

#### 2.3 服务间调用与注册发现（采用 Nacos）
- 注册发现：全量采用 `Nacos` 作为注册中心与配置中心；所有服务启动时自动注册到 Nacos。
- 调用方式：
  - 外部/前端 → 统一通过 `API网关`（Spring Cloud Gateway）
  - 服务间 → 使用 `OpenFeign + Spring Cloud LoadBalancer` 按“服务名”调用并负载均衡
- 配置管理：使用 `Nacos Config` 做统一配置，按`命名空间/分组/数据ID`区分环境与服务。
- 限流熔断：结合 `Sentinel`（可选）对关键接口进行保护。

示例（网关路由按服务名）：
```yaml
spring:
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true     # 允许按服务名自动路由
      routes:
        - id: order
          uri: lb://siam-order-service
          predicates:
            - Path=/order/**
```

示例（Feign 按服务名调用）：
```java
@FeignClient(name = "siam-order-service")
public interface OrderClient {
  @GetMapping("/api/order/{id}")
  OrderDTO get(@PathVariable Long id);
}
```

示例（Nacos 配置）:
```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_ADDR:127.0.0.1:8848}
        namespace: ${NACOS_NS:prod}
      config:
        server-addr: ${NACOS_ADDR:127.0.0.1:8848}
        namespace: ${NACOS_NS:prod}
        group: SIAM
        file-extension: yaml
```

## 3. 核心服务设计

### 3.1 服务拆分原则

按照DDD领域驱动设计思想，将系统拆分为5个业务域，每个域包含相关的微服务：

| 业务域 | 服务名称 | 核心职责 | 主要功能 |
|--------|----------|----------|----------|
| **用户域** | 用户服务 | C端用户管理 | • 微信注册登录<br/>• 用户资料管理<br/>• 收货地址管理<br/>• 账户信息维护 |
| **商户域** | 商户服务 | B端商户管理 | • 商户入驻审核<br/>• 店铺信息管理<br/>• 营业状态设置<br/>• 商户权限控制 |
| | 商品服务 | 商品信息管理 | • 外卖菜品管理<br/>• 平台自营商品<br/>• 团购商品设置<br/>• 库存规格管理 |
| **交易域** | 订单服务 | 订单全生命周期 | • 外卖/团购/采购订单<br/>• 订单状态机管理<br/>• 订单查询统计<br/>• 取消退款处理 |
| | 支付服务 | 支付结算 | • 微信支付集成<br/>• 支付回调处理<br/>• 企业付款(采购订单)<br/>• 退款对账 |
| **履约域** | 骑手服务 | 骑手管理 | • 骑手注册认证<br/>• 骑手信息维护<br/>• 收入结算管理<br/>• 骑手评价体系 |
| | 配送服务 | 配送履约 | • 订单抢单逻辑<br/>• 配送状态追踪<br/>• 骑手位置上报<br/>• 配送费计算 |
| **支撑域** | 通知服务 | 消息通知 | • 微信模板消息<br/>• 短信通知<br/>• 推送消息管理<br/>• 消息模板配置 |
| | 团购服务 | 团购业务 | • 团购商品发布<br/>• 核销码生成<br/>• 核销验证<br/>• 团购规则管理 |
| | 营销服务 | 优惠券/满减（MVP仅优惠券） | • 平台/店铺优惠券配置<br/>• 发放/领取<br/>• 下单校验与核销 |
| | 物流服务 | 采购订单物流 | • 物流单号管理<br/>• 快递API集成<br/>• 物流最新状态查询<br/>• 发货状态更新 |

### 服务间依赖关系

```mermaid
graph LR
    A[用户服务] --> D[订单服务]
    B[商户服务] --> C[商品服务]
    C --> D
    D --> E[支付服务]
    D --> G[配送服务]
    F[骑手服务] --> G
    H[通知服务] --> A
    H --> B
    H --> F
    I[团购服务] --> D
    J[物流服务] --> D
```

### 3.2 功能需求与业务域映射

根据贡享臻选2.0的功能结构图，详细说明每个功能需求在5个业务域中的归属：

#### 3.2.1 C端（用户端）功能映射（对齐美团，区分外卖与团购）

- 外卖与团购的用户路径完全不同，需分别设计。

##### A) 外卖（Takeaway）
| 功能模块 | 具体功能 | 负责业务域 | 负责服务 | 说明 |
|----------|----------|------------|----------|------|
| 首页/发现 | 附近商家列表、搜索、分类筛选 | 商户域 | 商品服务 | 展示可配送商家与菜品入口 |
| 商家详情 | 菜品列表、规格选择、门店信息、配送费展示 | 商户域 | 商品服务 | 支持规格与加购 |
| 购物车 | 加入购物车/修改数量/备注 | 交易域 | 订单服务 | 本地缓存+服务端校验 |
| 优惠券 | 选择可用优惠券 | 支撑域 | 营销服务 | 展示/选择可用平台券或店铺券 |
| 下单与支付 | 创建外卖订单、选择地址、计算配送费、微信支付 | 交易域 | 订单+支付服务 | 订单生成、价格校验、支付下单（结合`/api/promo/calc`与锁券） |
| 订单跟踪 | 最新位置与状态（待接单/待抢单/待取餐/配送中/已完成） | 交易域/履约域 | 订单/配送服务 | 轮询查询最新位置（MVP不展示地图轨迹） |
| 评价与售后 | 评价商家与骑手、退单/退款申请 | 履约域/交易域 | 骑手/订单服务 | 评价归属骑手与商家，售后走订单服务 |

##### B) 团购（GroupBuy）
| 功能模块 | 具体功能 | 负责业务域 | 负责服务 | 说明 |
|----------|----------|------------|----------|------|
| 团购列表 | 团购活动浏览、搜索、分类 | 支撑域 | 团购服务 | 展示在售团购活动 |
| 团购详情 | 套餐内容、有效期、使用规则、门店信息 | 支撑域 | 团购服务 | 展示核销规则与有效期 |
| 优惠券 | 选择可用优惠券（若支持） | 支撑域 | 营销服务 | MVP可先不支持团购券，预留展示入口 |
| 下单与支付 | 创建团购订单、微信支付 | 交易域 | 订单+支付服务 | 价格校验、生成订单（可接入`/api/promo/calc`） |
| 核销码 | 生成核销码、查看核销码 | 支撑域 | 团购服务 | 支付成功后生成一码多用/一次性码（按规则） |
| 使用记录 | 查看已使用/未使用、退款申请 | 支撑域/交易域 | 团购/订单服务 | 团购退款独立于外卖售后 |

#### 3.2.2 骑手端功能映射

| 功能模块 | 具体功能 | 负责业务域 | 负责服务 | 说明 |
|----------|----------|------------|----------|------|
| **抢单配送** | 附近订单查询 | 履约域 | 配送服务 | 基于位置查询待抢订单 |
| | 订单抢单 | 履约域 | 配送服务 | 分布式锁抢单逻辑 |
| | 配送状态管理 | 履约域 | 配送服务 | 订单状态流转（取餐→配送→完成） |
| | 位置上报 | 履约域 | 配送服务 | 实时位置同步 |
| **个人中心** | 骑手信息 | 履约域 | 骑手服务 | 个人资料、认证状态 |
| | 收入明细 | 履约域 | 骑手服务 | 配送费收入、结算记录 |
| | 服务评级 | 履约域 | 骑手服务 | 服务能力评估、评价管理 |

#### 3.2.3 商户端功能映射

**商户端权限原则**：商户只管理自己作为**卖家**时的商品和订单，不处理作为**买家**时的业务。

| 功能模块 | 具体功能 | 负责业务域 | 负责服务 | 说明 |
|----------|----------|------------|----------|------|
| **🛒 采购功能（商户作为买家）** | 商品商城首页 | 商户域 | 商品服务 | 浏览平台自营商品 |
| | 商品详情页 | 商户域 | 商品服务 | 查看自营商品详情、规格 |
| | 加入购物车 | 交易域 | 订单服务 | 采购商品购物车 |
| | 采购下单与支付 | 交易域 | 订单服务+支付服务 | 创建采购订单、企业付款 |
| | 采购订单查询 | 交易域 | 订单服务 | 查看采购订单状态 |
| | 物流信息查询 | 支撑域 | 物流服务 | 查询采购商品快递状态 |
| **🍜 外卖管理（商户作为卖家）** | 外卖订单管理 | 交易域 | 订单服务 | 接单/拒单/备餐状态更新 |
| | 外卖商品管理 | 商户域 | 商品服务 | 菜品上架、规格、价格设置 |
| **🎁 团购管理（商户作为卖家）** | 团购商品发布/管理 | 支撑域 | 团购服务 | 团购活动创建、管理 |
| | 团购订单管理 | 支撑域 | 团购服务 | 查看团购订单、核销记录 |
| | 使用门槛设置 | 支撑域 | 团购服务 | 团购规则配置 |
| | 核销记录查看 | 支撑域 | 团购服务 | 核销码使用记录 |
| **🧧 优惠券管理（商户）** | 店铺优惠券配置 | 支撑域 | 营销服务 | 创建店铺券（满减/无门槛）、有效期、适用范围 |
| | 发放与核销统计 | 支撑域 | 营销服务 | 查看发放与使用情况 |
| **🏪 店铺管理** | 门店资料编辑 | 商户域 | 商户服务 | 店铺基本信息维护 |
| | 营业时间设置 | 商户域 | 商户服务 | 营业时间配置 |
| | 营业状态切换 | 商户域 | 商户服务 | 开店/打烊状态管理 |
| | 门店公告发布 | 商户域 | 商户服务 | 店铺公告管理 |
| **💰 财务管理（卖家收入）** | 外卖收入流水 | 交易域 | 订单服务 | 外卖订单收入明细 |
| | 团购收入流水 | 交易域 | 订单服务 | 团购订单收入明细 |
| | 结算明细 | 交易域 | 支付服务 | 资金结算记录 |
| | 提现申请 | 交易域 | 支付服务 | 商户提现功能 |
| **🛠 售后处理（卖家订单）** | 外卖售后管理 | 交易域 | 订单服务 | 处理外卖退单/退款申请 |
| | 团购售后管理 | 交易域 | 订单服务 | 处理团购退款申请 |

#### 3.2.4 管理后台功能映射

| 功能模块 | 具体功能 | 负责业务域 | 负责服务 | 说明 |
|----------|----------|------------|----------|------|
| **用户管理** | 用户信息管理 | 用户域 | 用户服务 | C端用户信息维护 |
| **商户管理** | 商户入驻审核 | 商户域 | 商户服务 | 商户资质审核 |
| | 商户信息管理 | 商户域 | 商户服务 | 商户基本信息维护 |
| **商品管理** | 自营商品管理 | 商户域 | 商品服务 | 平台自营商品维护 |
| | 商品审核 | 商户域 | 商品服务 | 商户上架商品审核 |
| **订单管理** | 订单统计查询 | 交易域 | 订单服务 | 全平台订单数据统计 |
| | 采购订单管理（打包发货） | 交易域 | 订单服务 | 平台作为卖家，处理商户采购订单 |
| | 物流单号录入 | 支撑域 | 物流服务 | 采购订单发货后录入快递单号 |
| **营销管理** | 团购活动审核 | 支撑域 | 团购服务 | 团购活动审核管理 |
| | 平台优惠券配置 | 支撑域 | 营销服务 | 创建平台券、发放策略、人群圈选 |
| | 商户优惠活动审核（可选） | 支撑域 | 营销服务 | 审核商户提交的店铺券/活动 |
| | 优惠活动配置 | 交易域 | 订单服务 | 平台优惠活动设置 |
| **系统配置** | 系统参数配置 | 支撑域 | 通知服务 | 系统基础配置管理 |
| | 消息模板管理 | 支撑域 | 通知服务 | 微信消息模板配置 |

#### 3.2.5 业务域职责总结

| 业务域 | 核心职责范围 | 主要端点支持 |
|--------|--------------|--------------|
| **用户域** | C端用户的注册登录、资料管理、地址管理 | C端（用户端） |
| **商户域** | B端商户管理、所有商品管理（外卖菜品+自营商品+团购商品） | 商户端、管理后台 |
| **交易域** | 所有类型订单（外卖+团购+采购）、支付结算、售后处理 | 所有端点 |
| **履约域** | 外卖订单的骑手抢单配送、骑手管理、评价体系 | 骑手端、C端（评价） |
| **支撑域** | 消息通知、团购业务、采购订单物流查询 | 所有端点（辅助功能） |

#### 3.2.6 业务角色关系说明

不同业务场景中，商户和平台扮演不同的买卖角色：

| 业务场景 | 买家 | 卖家 | 商户端功能 | 平台管理功能 |
|----------|------|------|------------|--------------|
| **外卖订单** | 用户 | 商户 | 接单、拒单、备餐状态更新 | 订单监控、数据统计 |
| **团购订单** | 用户 | 平台+商户 | 发布团购、设置规则、核销 | 团购审核、规则管理 |
| **采购订单** | 商户 | 平台 | 下单、支付、查询物流 | 订单处理、打包发货、录入快递单号 |

**🎯 关键理解**：
- 商户在**外卖场景**是卖家 → 有订单处理权限
- 商户在**采购场景**是买家 → 只能查询不能发货
- 平台在**采购场景**是卖家 → 负责发货和物流管理

### 3.3 核心服务职责

#### 用户服务 (User Service)
- **职责**：用户注册登录、资料管理、地址管理
- **核心API**：
  - `POST /api/user/register` - 用户注册
  - `POST /api/user/login` - 微信登录
  - `GET /api/user/profile` - 获取用户信息
  - `POST /api/user/address` - 新增地址

#### 商户服务 (Merchant Service)
- **职责**：商户入驻、店铺管理、营业设置
- **核心API**：
  - `POST /api/merchant/register` - 商户入驻
  - `GET /api/merchant/info` - 店铺信息
  - `PUT /api/merchant/status` - 营业状态切换

#### 商品服务 (Product Service)  
- **职责**：商品管理、库存管理、分类规格（支持外卖菜品和平台自营商品）
- **核心API**：
  - `POST /api/product/create` - 创建商品（外卖菜品/平台自营商品）
  - `GET /api/product/merchant-list` - 商户菜品列表
  - `GET /api/product/platform-list` - 平台自营商品列表  
  - `PUT /api/product/stock` - 更新库存

#### 订单服务 (Order Service)
- **职责**：订单创建、状态管理、查询取消
- **核心API**：
  - `POST /api/order/create` - 创建订单
  - `GET /api/order/detail` - 订单详情
  - `PUT /api/order/cancel` - 取消订单

#### 支付服务 (Payment Service)
- **职责**：微信支付集成、回调处理、退款
- **核心API**：
  - `POST /api/payment/create` - 创建支付单
  - `POST /api/payment/callback` - 支付回调
  - `POST /api/payment/refund` - 申请退款

#### 骑手服务 (Rider Service)
- **职责**：骑手注册认证、收入管理、评价
- **核心API**：
  - `POST /api/rider/register` - 骑手注册
  - `GET /api/rider/profile` - 骑手信息
  - `GET /api/rider/earnings` - 收入统计

#### 配送服务 (Delivery Service)
- **职责**：订单抢单、配送状态、位置追踪
- **核心API**：
  - `GET /api/delivery/nearby-orders` - 附近订单
  - `POST /api/delivery/grab-order` - 抢单
  - `PUT /api/delivery/update-status` - 更新配送状态

#### 通知服务 (Notification Service)
- **职责**：订单状态查询页面数据提供（MVP仅在小程序内查看，不做外部推送）
- **核心API**：
  - `GET /api/notify/order-status/{orderNo}` - 查询订单当前状态与时间轴
  - `GET /api/notify/order-timeline/{orderNo}` - 查询订单状态变更记录

> 说明：MVP阶段不做微信模板消息/短信推送，仅在小程序内提供"订单消息中心"页面轮询查看状态；后续可无缝升级为模板消息推送。

#### 团购服务 (GroupBuy Service) 
- **职责**：团购商品管理、核销码生成、团购规则
- **核心API**：
  - `POST /api/groupbuy/create` - 创建团购商品
  - `POST /api/groupbuy/generate-voucher` - 生成核销码
  - `POST /api/groupbuy/verify-voucher` - 核销验证

#### 物流服务 (Logistics Service)
- **职责**：采购订单物流单号管理、快递查询API集成、物流最新状态查询（MVP不做完整轨迹）
- **核心API**：
  - `PUT /api/logistics/update-order-tracking` - 录入物流单号(管理后台)
  - `GET /api/logistics/query-tracking` - 查询物流最新状态(对接阿里云快递查询API)
  - `GET /api/logistics/track-detail` - 预留接口，后续支持轨迹

#### 评价与审核 (Review Service - 简化并归属交易域)
- **职责**：订单评价管理（商家评分/骑手评分分开）、商家审核决定是否展示
- **规则**：
  - 用户完成订单后可分别对商家与骑手打分与评价
  - 评价默认状态为`pending`（待审核），仅商家后台可查看并进行“通过/隐藏”处理
  - 通过后评价对其他用户展示；隐藏则仅平台可见用于风控
- **核心API**：
  - `POST /api/review/submit` - 提交评价（参数：orderId、merchantScore、merchantComment、riderScore、riderComment、images[]）
  - `GET /api/review/list-by-merchant` - 商家后台查询店铺所有评价（含待审核）
  - `PUT /api/review/moderate` - 商家审核评价（approve=通过展示 / reject=隐藏）
  - `GET /api/review/public-list` - 前台展示已通过评价
- **数据模型（MVP建议）**：
  - 表`tb_review`：`id, order_id, merchant_id, rider_id, user_id, merchant_score, merchant_comment, rider_score, rider_comment, images(json), status(pending|approved|hidden), created_time, updated_time`
  - 表`tb_review_audit_log`：`id, review_id, auditor_id(商户管理员), action(approve|reject), remark, created_time`

#### 营销服务 (Promotion Service)
- **职责**：优惠券（MVP聚焦）与基础满减规则（预留）
- **优惠券模型（MVP）**：
  - 类型：满减券（满X减Y）、无门槛券（减Y）
  - 维度：平台券/店铺券
  - 约束：有效期、适用商品/分类、每人限领次数
  - 状态：未开始/进行中/已结束/已失效
- **核心API**：
  - `POST /api/promo/coupon/create` - 创建优惠券（平台/店铺）
  - `POST /api/promo/coupon/issue` - 发放优惠券（按人群/手动发放）
  - `GET /api/promo/coupon/my` - 我的优惠券列表（未使用/已使用/已过期）
  - `POST /api/promo/coupon/lock` - 下单前锁定优惠券（防并发）
  - `POST /api/promo/coupon/consume` - 支付成功后核销优惠券
  - `POST /api/promo/calc` - 下单价格计算（返回可用优惠券与应付金额）

> 说明：MVP仅实现优惠券；满减/限时活动等统一走订单价计算预留接口`/api/promo/calc`，后续扩展不影响下单流程。

## 4. 关键业务流程

### 4.1 用户外卖下单流程

```mermaid
sequenceDiagram
    participant U as 用户小程序
    participant G as 网关
    participant O as 订单服务
    participant P as 商品服务  
    participant Pay as 支付服务
    participant D as 配送服务
    participant N as 通知服务
    participant M as 商户
    
    U->>G: 提交外卖订单
    G->>O: 创建外卖订单(order_type=takeaway)
    O->>P: 检查菜品库存
    P-->>O: 库存充足
    O->>O: 保存订单(待支付状态)
    O-->>G: 返回订单信息
    
    G->>Pay: 创建支付单
    Pay->>Pay: 调用微信支付
    Pay-->>G: 返回支付参数
    G-->>U: 返回支付参数
    
    Note over U: 用户完成支付
    
    Pay->>Pay: 接收微信回调
    Pay->>O: 通知支付成功
    O->>O: 更新订单状态(待商户接单)
    O->>N: 记录订单状态用于"订单消息中心"
    Note over U: 用户可在小程序"订单消息中心"查看最新状态（MVP无模板消息推送）
```

### 4.2 用户团购下单流程

```mermaid
sequenceDiagram
    participant U as 用户小程序
    participant G as 网关
    participant O as 订单服务
    participant GB as 团购服务
    participant Pay as 支付服务
    participant N as 通知服务
    
    U->>G: 提交团购订单
    G->>O: 创建团购订单(order_type=groupbuy)
    O->>GB: 检查团购商品库存和规则
    GB-->>O: 团购有效，库存充足
    O->>O: 保存订单(待支付状态)
    O-->>G: 返回订单信息
    
    G->>Pay: 创建支付单
    Pay->>Pay: 调用微信支付
    Pay-->>G: 返回支付参数
    G-->>U: 返回支付参数
    
    Note over U: 用户完成支付
    
    Pay->>Pay: 接收微信回调
    Pay->>O: 通知支付成功
    O->>GB: 生成核销码
    GB-->>O: 返回核销码信息
    O->>O: 更新订单状态(已支付,待核销)
    O->>N: 记录订单状态（供消息中心查询）
```

### 4.3 商户采购订单流程

```mermaid
sequenceDiagram
    participant M as 商户小程序
    participant G as 网关
    participant O as 订单服务
    participant P as 平台自营商品服务
    participant Pay as 支付服务
    participant Admin as 平台运营人员
    participant SF as 顺丰快递
    participant L as 物流查询API
    participant N as 通知服务
    
    M->>G: 商户提交采购订单
    G->>O: 创建采购订单(order_type=b2b_purchase)
    O->>P: 检查自营商品库存
    P-->>O: 库存充足
    O->>O: 保存订单(待支付状态)
    O-->>G: 返回订单信息
    
    G->>Pay: 创建支付单
    Pay->>Pay: 调用微信支付(企业付款)
    Pay-->>G: 返回支付参数
    G-->>M: 返回支付参数
    
    Note over M: 商户完成支付
    
    Pay->>Pay: 接收微信回调
    Pay->>O: 通知支付成功
    O->>O: 更新订单状态(待发货)
    O->>N: 通知平台运营人员有新的B2B订单
    N->>Admin: 微信/短信通知新订单待发货
    
    Note over Admin: 平台运营人员线下安排发货
    Admin->>SF: 线下联系顺丰，安排商品发货
    SF-->>Admin: 返回快递单号
    
    Admin->>G: 在管理后台录入物流单号
    G->>O: 更新订单物流信息(logistics_no, status=已发货)
    O->>N: 记录物流状态（供消息中心查询）
    
    Note over M: 商户查询物流状态
    M->>G: 查询订单物流信息
    G->>L: 调用快递查询API(阿里云市场)
    L-->>G: 返回物流最新状态
    G-->>M: 显示物流最新进度（MVP不展示完整轨迹）
```

### 4.4 骑手抢单流程

```mermaid
sequenceDiagram
    participant R as 骑手小程序
    participant G as 网关
    participant D as 配送服务
    participant Redis as Redis缓存
    participant O as 订单服务
    participant N as 通知服务
    participant U as 用户
    participant M as 商户
    
    Note over R: 骑手打开小程序，上报当前位置
    
    R->>G: 查询附近待抢单订单(lat, lng, radius=3km)
    G->>D: 基于骑手位置查询可抢订单
    D->>O: 查询status=3(待抢单)的订单
    O-->>D: 返回符合条件的订单
    D->>D: 根据距离筛选3km内订单
    D-->>G: 返回可抢订单列表
    G-->>R: 显示附近订单（距离、配送费、商户、地址）
    
    Note over R: 骑手浏览订单，选择心仪订单点击抢单
    
    R->>G: 提交抢单请求(orderId, riderId)
    G->>D: 执行抢单逻辑
    
    D->>Redis: 获取分布式锁(grab_order_lock:orderId)
    Redis-->>D: 锁获取成功
    
    D->>O: 检查订单状态是否仍为待抢单
    O-->>D: 订单状态正常，可抢
    D->>O: 更新订单(status=4待取餐, rider_id)
    O-->>D: 更新成功
    
    D->>Redis: 释放分布式锁
    D-->>G: 抢单成功
    G-->>R: 返回成功，跳转配送任务页面
    
    D->>N: 通知用户骑手已接单
    N->>U: 微信推送"骑手xxx已接单，正在前往商家取餐"
    
    D->>N: 通知商户有骑手接单
    N->>M: 微信推送"订单xxx已被骑手接单，请准备餐品"
```

## 5. 数据库设计 (MVP单库架构)

### 5.1 核心数据表

#### 用户相关表
```sql
-- 用户表
CREATE TABLE `tb_user` (
    `id` int NOT NULL AUTO_INCREMENT,
    `openid` varchar(50) NOT NULL COMMENT '微信openid',
    `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
    `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
    `avatar` varchar(200) DEFAULT NULL COMMENT '头像',
    `status` tinyint DEFAULT 1 COMMENT '状态：1=正常',
    `created_time` datetime NOT NULL,
    `updated_time` datetime NOT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_openid` (`openid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- 用户地址表
CREATE TABLE `tb_user_address` (
    `id` int NOT NULL AUTO_INCREMENT,
    `user_id` int NOT NULL COMMENT '用户ID',
    `name` varchar(50) NOT NULL COMMENT '收货人姓名',
    `phone` varchar(20) NOT NULL COMMENT '联系电话',
    `province` varchar(20) NOT NULL COMMENT '省份',
    `city` varchar(20) NOT NULL COMMENT '城市',
    `area` varchar(20) NOT NULL COMMENT '区县',
    `street` varchar(100) NOT NULL COMMENT '详细地址',
    `longitude` decimal(10,7) NOT NULL COMMENT '经度',
    `latitude` decimal(10,7) NOT NULL COMMENT '纬度',
    `is_default` tinyint DEFAULT 0 COMMENT '是否默认',
    `created_time` datetime NOT NULL,
    PRIMARY KEY (`id`),
    KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户地址表';
```

#### 商户商品表
```sql
-- 商户表
CREATE TABLE `tb_merchant` (
    `id` int NOT NULL AUTO_INCREMENT,
    `name` varchar(100) NOT NULL COMMENT '商户名称',
    `phone` varchar(20) NOT NULL COMMENT '联系电话',
    `address` varchar(200) NOT NULL COMMENT '商户地址',
    `longitude` decimal(10,7) NOT NULL COMMENT '经度',
    `latitude` decimal(10,7) NOT NULL COMMENT '纬度',
    `status` tinyint DEFAULT 1 COMMENT '状态：1=营业中，2=休息中',
    `created_time` datetime NOT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商户表';

-- 商品表（支持外卖菜品和平台自营商品）
CREATE TABLE `tb_product` (
    `id` int NOT NULL AUTO_INCREMENT,
    `product_type` tinyint NOT NULL COMMENT '商品类型：1=外卖菜品，2=平台自营商品，3=团购商品',
    `merchant_id` int DEFAULT NULL COMMENT '商户ID（外卖菜品）',
    `platform_category_id` int DEFAULT NULL COMMENT '平台商品分类ID（自营商品）',
    `name` varchar(100) NOT NULL COMMENT '商品名称',
    `price` decimal(8,2) NOT NULL COMMENT '价格',
    `stock` int DEFAULT 999 COMMENT '库存',
    `image_url` varchar(200) DEFAULT NULL COMMENT '商品图片',
    `description` text COMMENT '商品描述',
    `specifications` json DEFAULT NULL COMMENT '商品规格（JSON）',
    `status` tinyint DEFAULT 1 COMMENT '状态：1=上架，2=下架',
    `min_order_qty` int DEFAULT 1 COMMENT '起订量（B2B商品）',
    `unit` varchar(20) DEFAULT '份' COMMENT '单位',
    `created_time` datetime NOT NULL,
    `updated_time` datetime NOT NULL,
    PRIMARY KEY (`id`),
    KEY `idx_merchant_id` (`merchant_id`),
    KEY `idx_product_type_status` (`product_type`, `status`),
    KEY `idx_platform_category` (`platform_category_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品表（支持外卖菜品和平台自营商品）';
```

#### 订单相关表
```sql
-- 订单表（统一外卖、团购、采购订单）
CREATE TABLE `tb_order` (
    `id` int NOT NULL AUTO_INCREMENT,
    `order_no` varchar(50) NOT NULL COMMENT '订单号',
    `order_type` varchar(20) NOT NULL COMMENT '订单类型：takeaway=外卖，groupbuy=团购，purchase=采购订单',
    `buyer_id` int NOT NULL COMMENT '买方ID（用户ID或商户ID）',
    `buyer_type` tinyint NOT NULL COMMENT '买方类型：1=用户，2=商户',
    `seller_id` int DEFAULT NULL COMMENT '卖方ID（商户ID或平台）',
    `total_amount` decimal(8,2) NOT NULL COMMENT '订单总金额',
    `delivery_fee` decimal(8,2) DEFAULT 0.00 COMMENT '配送费',
    `actual_amount` decimal(8,2) NOT NULL COMMENT '实际支付金额',
    `status` tinyint NOT NULL COMMENT '订单状态：1=待支付，2=待商户接单，3=待抢单，4=待取餐，5=配送中，6=已完成，7=已取消（外卖）；对于团购：2=待核销，6=已完成；对于采购订单：2=待发货，3=已发货，4=运输中，6=已完成',
    `delivery_address` text COMMENT '配送地址（外卖）',
    `delivery_longitude` decimal(10,7) COMMENT '配送经度',
    `