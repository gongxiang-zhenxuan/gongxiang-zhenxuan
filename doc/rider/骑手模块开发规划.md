# è´¡äº«è‡»é€‰éª‘æ‰‹æ¨¡å—å¼€å‘è§„åˆ’

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

åŸºäºè´¡äº«è‡»é€‰å¾®æœåŠ¡æ¶æ„ï¼Œå¼€å‘å®Œæ•´çš„éª‘æ‰‹æŠ¢å•é…é€ç³»ç»Ÿï¼Œå®ç°ç¾å›¢å¼å¤–å–é…é€æ¨¡å¼ã€‚

### ğŸ¯ æ ¸å¿ƒç›®æ ‡
- âœ… éª‘æ‰‹æ³¨å†Œå’Œè®¤è¯ç®¡ç†
- âœ… åŸºäºåœ°ç†ä½ç½®çš„æ™ºèƒ½è®¢å•æ¨é€
- âœ… Redisåˆ†å¸ƒå¼é”é˜²é‡å¤æŠ¢å•
- âœ… é…é€çŠ¶æ€å®æ—¶è¿½è¸ª
- âœ… æ”¶å…¥ç»“ç®—å’Œç»Ÿè®¡åˆ†æ

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æœåŠ¡åˆ’åˆ†
```
gxz-delivery (é…é€æœåŠ¡)
â”œâ”€â”€ delivery-api/           # API æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ dto/               # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ vo/                # è§†å›¾å¯¹è±¡  
â”‚   â”œâ”€â”€ enums/             # æšä¸¾å®šä¹‰
â”‚   â””â”€â”€ feign/             # Feign å®¢æˆ·ç«¯
â””â”€â”€ delivery-provider/      # æœåŠ¡å®ç°
    â”œâ”€â”€ controller/        # æ§åˆ¶å™¨å±‚
    â”œâ”€â”€ service/           # æœåŠ¡å±‚
    â”œâ”€â”€ mapper/            # æ•°æ®è®¿é—®å±‚
    â”œâ”€â”€ entity/            # å®ä½“ç±»
    â””â”€â”€ config/            # é…ç½®ç±»

gxz-settlement (ç»“ç®—æœåŠ¡)
â””â”€â”€ éª‘æ‰‹æ”¶å…¥è®¡ç®—å’Œç»“ç®—
```

## ğŸš€ åˆ†é˜¶æ®µå¼€å‘è®¡åˆ’

### Phase 1: åŸºç¡€éª‘æ‰‹ç®¡ç† (1å‘¨)

#### å·²å®Œæˆ âœ…
- [x] éª‘æ‰‹å®ä½“ç±»è®¾è®¡ (Rider.java)
- [x] é…é€è®¢å•å®ä½“ç±» (DeliveryOrder.java)
- [x] çŠ¶æ€æšä¸¾å®šä¹‰ (RiderStatus, DeliveryOrderStatus)
- [x] éª‘æ‰‹ç®¡ç†æœåŠ¡å®ç° (RiderServiceImpl.java)
- [x] åŸºç¡€DTO/VOå®šä¹‰

#### å¾…å®Œæˆ ğŸ”²
```java
// æ•°æ®è®¿é—®å±‚
RiderMapper.java
DeliveryOrderMapper.java

// æœåŠ¡æ¥å£å®šä¹‰
RiderService.java
OrderGrabService.java

// é…ç½®æ–‡ä»¶
application.yml
redisé…ç½®
æ•°æ®åº“é…ç½®
```

### Phase 2: æŠ¢å•æ ¸å¿ƒé€»è¾‘ (1.5å‘¨)

#### å·²å®Œæˆ âœ…
- [x] æŠ¢å•æœåŠ¡å®ç° (OrderGrabServiceImpl.java)
- [x] åˆ†å¸ƒå¼é”é˜²é‡å¤æŠ¢å•
- [x] åœ°ç†ä½ç½®æŸ¥è¯¢ç®—æ³•
- [x] é…é€çŠ¶æ€æœºè®¾è®¡

#### å¾…å®Œæˆ ğŸ”²
```java
// ä½ç½®è¿½è¸ªæœåŠ¡
LocationTrackingService.java
- éª‘æ‰‹ä½ç½®ä¸ŠæŠ¥
- å®æ—¶ä½ç½®ç¼“å­˜
- è½¨è¿¹è®°å½•

// å¾®ä¿¡æ¨é€æœåŠ¡  
WeChatNotificationService.java
- æŠ¢å•æˆåŠŸé€šçŸ¥
- è®¢å•çŠ¶æ€æ¨é€
- æ¨¡æ¿æ¶ˆæ¯å‘é€
```

### Phase 3: APIæ¥å£å®Œå–„ (1å‘¨)

#### å·²å®Œæˆ âœ…
- [x] éª‘æ‰‹ç®¡ç†æ§åˆ¶å™¨ (RiderController.java)

#### å¾…å®Œæˆ ğŸ”²
```java
// å®Œå–„æ§åˆ¶å™¨åŠŸèƒ½
- éª‘æ‰‹å†å²è®¢å•æŸ¥è¯¢
- æ”¶å…¥ç»Ÿè®¡æ¥å£
- è¯„ä»·æŸ¥çœ‹æ¥å£

// æ–°å¢æ§åˆ¶å™¨
LocationController.java      # ä½ç½®ç›¸å…³æ¥å£
IncomeController.java        # æ”¶å…¥ç›¸å…³æ¥å£
RatingController.java        # è¯„ä»·ç›¸å…³æ¥å£
```

### Phase 4: æ”¶å…¥ç»“ç®—ç³»ç»Ÿ (1.5å‘¨)

```java
// æ”¶å…¥è®¡ç®—æœåŠ¡
RiderIncomeService.java
- åŸºç¡€é…é€è´¹è®¡ç®—
- è·ç¦»è¡¥è´´è®¡ç®—  
- æ—¶é—´/å¤©æ°”/å¤œé—´è¡¥è´´
- å¥½è¯„å¥–åŠ±è®¡ç®—
- å¹³å°æŠ½æˆæ‰£é™¤

// ç»“ç®—æœåŠ¡
SettlementService.java
- æ—¥ç»“/å‘¨ç»“ç®—
- æ”¶å…¥æŠ¥è¡¨ç”Ÿæˆ
- æç°åŠŸèƒ½
```

### Phase 5: æ•°æ®ç»Ÿè®¡åˆ†æ (1å‘¨)

```java
// ç»Ÿè®¡åˆ†ææœåŠ¡
RiderStatsService.java
- é…é€æ•ˆç‡ç»Ÿè®¡
- æ”¶å…¥è¶‹åŠ¿åˆ†æ
- æœåŠ¡è´¨é‡åˆ†æ
- æ’è¡Œæ¦œåŠŸèƒ½

// æŠ¥è¡¨æœåŠ¡
ReportService.java  
- éª‘æ‰‹æ”¶å…¥æŠ¥è¡¨
- é…é€æ•°æ®æŠ¥è¡¨
- å¼‚å¸¸åˆ†ææŠ¥è¡¨
```

## ğŸ“Š æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 1. æ™ºèƒ½æŠ¢å•æœºåˆ¶

```mermaid
graph TD
    A[è®¢å•æ”¯ä»˜å®Œæˆ] --> B[åˆ›å»ºé…é€è®¢å•]
    B --> C[è®¡ç®—é…é€èŒƒå›´]
    C --> D[æŸ¥è¯¢é™„è¿‘åœ¨çº¿éª‘æ‰‹]
    D --> E[æ¨é€è®¢å•ç»™éª‘æ‰‹]
    E --> F[éª‘æ‰‹æŠ¢å•]
    F --> G{åˆ†å¸ƒå¼é”}
    G -->|è·å–æˆåŠŸ| H[æ›´æ–°è®¢å•çŠ¶æ€]
    G -->|è·å–å¤±è´¥| I[æŠ¢å•å¤±è´¥]
    H --> J[é€šçŸ¥éª‘æ‰‹å‰å¾€å–é¤]
```

### 2. é…é€çŠ¶æ€æµè½¬

```mermaid
stateDiagram-v2
    [*] --> å¾…æŠ¢å•
    å¾…æŠ¢å• --> å¾…å–é¤: æŠ¢å•æˆåŠŸ
    å¾…å–é¤ --> éª‘æ‰‹å·²åˆ°åº—: éª‘æ‰‹ç‚¹å‡»åˆ°åº—
    éª‘æ‰‹å·²åˆ°åº— --> å·²å–é¤: éª‘æ‰‹ç‚¹å‡»å–é¤
    å·²å–é¤ --> é…é€ä¸­: å¼€å§‹é…é€
    é…é€ä¸­ --> å·²é€è¾¾: éª‘æ‰‹ç¡®è®¤é€è¾¾
    å·²é€è¾¾ --> å·²å®Œæˆ: ç”¨æˆ·ç¡®è®¤/ç³»ç»Ÿè‡ªåŠ¨
    
    å¾…æŠ¢å• --> å·²å–æ¶ˆ: è¶…æ—¶æ— äººæŠ¢å•
    å¾…å–é¤ --> å·²å–æ¶ˆ: å¼‚å¸¸å–æ¶ˆ
    é…é€ä¸­ --> å·²å–æ¶ˆ: å¼‚å¸¸å–æ¶ˆ
```

### 3. æ”¶å…¥è®¡ç®—å…¬å¼

```
éª‘æ‰‹å®é™…æ”¶å…¥ = åŸºç¡€é…é€è´¹ + è·ç¦»è¡¥è´´ + æ—¶é—´è¡¥è´´ + å¤©æ°”è¡¥è´´ + å¤œé—´è¡¥è´´ + å¥½è¯„å¥–åŠ± - å¹³å°æœåŠ¡è´¹

å…¶ä¸­:
- åŸºç¡€é…é€è´¹ = è®¢å•é…é€è´¹ Ã— (1 - å¹³å°æŠ½æˆæ¯”ä¾‹)
- è·ç¦»è¡¥è´´ = è¶…å‡ºåŸºç¡€è·ç¦» Ã— æ¯å…¬é‡Œè¡¥è´´
- æ—¶é—´è¡¥è´´ = é«˜å³°æ—¶æ®µ Ã— æ—¶é—´ç³»æ•°
- å¤©æ°”è¡¥è´´ = æ¶åŠ£å¤©æ°” Ã— å¤©æ°”ç³»æ•°
- å¤œé—´è¡¥è´´ = å¤œé—´é…é€ Ã— å¤œé—´ç³»æ•°
- å¥½è¯„å¥–åŠ± = 5æ˜Ÿå¥½è¯„ Ã— å¥–åŠ±é‡‘é¢
```

## ğŸ› ï¸ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. åœ°ç†ä½ç½®ä¼˜åŒ–
```java
// ä½¿ç”¨GeoHashç®—æ³•ä¼˜åŒ–ä½ç½®æŸ¥è¯¢
// Redis Geoæ•°æ®ç»“æ„å­˜å‚¨å®æ—¶ä½ç½®
redisTemplate.opsForGeo().add("rider:geo", 
    new Point(longitude, latitude), riderId.toString());

// æŸ¥è¯¢é™„è¿‘éª‘æ‰‹
List<GeoResult<RedisGeoCommands.GeoLocation<String>>> results = 
    redisTemplate.opsForGeo().radius("rider:geo", 
        new Circle(point, new Distance(5, Metrics.KILOMETERS)));
```

### 2. åˆ†å¸ƒå¼é”å®ç°
```java
// ä½¿ç”¨Redissonå®ç°åˆ†å¸ƒå¼é”
RLock lock = redissonClient.getLock("order:grab:lock:" + orderId);
try {
    if (lock.tryLock(1, 30, TimeUnit.SECONDS)) {
        // æ‰§è¡ŒæŠ¢å•é€»è¾‘
    }
} finally {
    if (lock.isHeldByCurrentThread()) {
        lock.unlock();
    }
}
```

### 3. å¾®ä¿¡æ¨é€é›†æˆ
```java
// å¾®ä¿¡å°ç¨‹åºæ¨¡æ¿æ¶ˆæ¯æ¨é€
@Service
public class WeChatPushService {
    
    public void sendOrderGrabNotification(Long riderId, Order order) {
        // æ„å»ºæ¨¡æ¿æ¶ˆæ¯
        TemplateMessage message = new TemplateMessage();
        message.setTouser(rider.getOpenId());
        message.setTemplate_id("ORDER_GRAB_SUCCESS_TEMPLATE_ID");
        // å‘é€æ¶ˆæ¯
        weChatApiService.sendTemplateMessage(message);
    }
}
```

## ğŸ“ APIæ¥å£è®¾è®¡

### éª‘æ‰‹ç®¡ç†æ¥å£
```http
POST /api/rider/register           # éª‘æ‰‹æ³¨å†Œ
GET  /api/rider/info/{riderId}     # è·å–éª‘æ‰‹ä¿¡æ¯
POST /api/rider/status/update      # æ›´æ–°åœ¨çº¿çŠ¶æ€
POST /api/rider/location/update    # æ›´æ–°ä½ç½®ä¿¡æ¯
```

### æŠ¢å•é…é€æ¥å£
```http
POST /api/rider/orders/nearby      # æŸ¥è¯¢é™„è¿‘è®¢å•
POST /api/rider/order/grab         # æŠ¢å•
POST /api/rider/order/status/update # æ›´æ–°é…é€çŠ¶æ€
GET  /api/rider/orders/current/{riderId} # å½“å‰è®¢å•
POST /api/rider/orders/history     # å†å²è®¢å•
```

### æ”¶å…¥ç»Ÿè®¡æ¥å£
```http
GET /api/rider/income/stats/{riderId}    # æ”¶å…¥ç»Ÿè®¡
GET /api/rider/income/details/{riderId}  # æ”¶å…¥æ˜ç»†
POST /api/rider/income/withdraw          # ç”³è¯·æç°
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„
- **tb_rider** - éª‘æ‰‹åŸºç¡€ä¿¡æ¯è¡¨
- **tb_delivery_order** - é…é€è®¢å•è¡¨
- **tb_rider_location_history** - éª‘æ‰‹ä½ç½®è½¨è¿¹è¡¨
- **tb_rider_income** - éª‘æ‰‹æ”¶å…¥è®°å½•è¡¨
- **tb_rider_rating** - éª‘æ‰‹è¯„ä»·è¡¨

### å…³é”®ç´¢å¼•è®¾è®¡
```sql
-- æŠ¢å•æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•
KEY `idx_grab_orders` (`status`, `grab_deadline`, `pickup_longitude`, `pickup_latitude`)

-- éª‘æ‰‹ä½ç½®æŸ¥è¯¢ç´¢å¼•  
KEY `idx_location` (`current_longitude`, `current_latitude`)

-- æ”¶å…¥ç»Ÿè®¡æŸ¥è¯¢ç´¢å¼•
KEY `idx_rider_income` (`rider_id`, `create_time`)
```

## ğŸš¦ å¼€å‘ä¼˜å…ˆçº§

### P0 - æ ¸å¿ƒåŠŸèƒ½ (å¿…é¡»)
- [x] éª‘æ‰‹æ³¨å†Œè®¤è¯
- [x] è®¢å•æŠ¢å•æœºåˆ¶
- [x] é…é€çŠ¶æ€ç®¡ç†
- [ ] ä½ç½®å®æ—¶è¿½è¸ª

### P1 - é‡è¦åŠŸèƒ½ (é‡è¦)
- [ ] æ”¶å…¥ç»“ç®—ç³»ç»Ÿ
- [ ] å¾®ä¿¡æ¨é€é€šçŸ¥
- [ ] å†å²è®¢å•æŸ¥è¯¢
- [ ] åŸºç¡€ç»Ÿè®¡æŠ¥è¡¨

### P2 - å¢å¼ºåŠŸèƒ½ (å¯é€‰)
- [ ] æ™ºèƒ½è·¯å¾„è§„åˆ’
- [ ] å¤šè®¢å•å¹¶è¡Œé…é€
- [ ] é«˜çº§æ•°æ®åˆ†æ
- [ ] éª‘æ‰‹æ’è¡Œæ¦œ

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å“åº”æ—¶é—´è¦æ±‚
- é™„è¿‘è®¢å•æŸ¥è¯¢: < 500ms
- æŠ¢å•æ“ä½œ: < 1s
- ä½ç½®æ›´æ–°: < 200ms
- çŠ¶æ€æŸ¥è¯¢: < 300ms

### å¹¶å‘å¤„ç†èƒ½åŠ›
- æ”¯æŒ1000+éª‘æ‰‹åŒæ—¶åœ¨çº¿
- æ”¯æŒ500+è®¢å•å¹¶å‘æŠ¢å•
- æ”¯æŒ10000+/åˆ†é’Ÿä½ç½®æ›´æ–°

## ğŸ” æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
- [ ] æœåŠ¡å±‚é€»è¾‘æµ‹è¯•
- [ ] å·¥å…·ç±»æ–¹æ³•æµ‹è¯•  
- [ ] æšä¸¾çŠ¶æ€è½¬æ¢æµ‹è¯•

### é›†æˆæµ‹è¯•
- [ ] æŠ¢å•å®Œæ•´æµç¨‹æµ‹è¯•
- [ ] é…é€çŠ¶æ€æµè½¬æµ‹è¯•
- [ ] æ”¶å…¥è®¡ç®—å‡†ç¡®æ€§æµ‹è¯•

### å‹åŠ›æµ‹è¯•
- [ ] æŠ¢å•å¹¶å‘å‹åŠ›æµ‹è¯•
- [ ] ä½ç½®æ›´æ–°é¢‘æ¬¡æµ‹è¯•
- [ ] æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æµ‹è¯•

## ğŸ“… é‡Œç¨‹ç¢‘è®¡åˆ’

| é‡Œç¨‹ç¢‘ | å®Œæˆæ—¶é—´ | äº¤ä»˜å†…å®¹ |
|-------|---------|----------|
| **M1** | Week 1 | éª‘æ‰‹æ³¨å†Œå’ŒåŸºç¡€ç®¡ç†åŠŸèƒ½ |
| **M2** | Week 2.5 | æŠ¢å•æ ¸å¿ƒé€»è¾‘å®Œæˆ |
| **M3** | Week 3.5 | APIæ¥å£å’Œå‰ç«¯å¯¹æ¥ |
| **M4** | Week 5 | æ”¶å…¥ç»“ç®—ç³»ç»Ÿ |
| **M5** | Week 6 | æ•°æ®ç»Ÿè®¡å’Œä¼˜åŒ– |

## ğŸ¯ æˆåŠŸéªŒæ”¶æ ‡å‡†

### åŠŸèƒ½æ ‡å‡†
- [x] éª‘æ‰‹å¯ä»¥æˆåŠŸæ³¨å†Œå’Œè®¤è¯
- [x] éª‘æ‰‹å¯ä»¥æŸ¥çœ‹å¹¶æŠ¢å–é™„è¿‘è®¢å•
- [x] é…é€çŠ¶æ€å¯ä»¥æ­£ç¡®æµè½¬
- [ ] æ”¶å…¥å¯ä»¥å‡†ç¡®è®¡ç®—å’Œç»“ç®—
- [ ] ç»Ÿè®¡æ•°æ®å‡†ç¡®å¯æŸ¥

### æ€§èƒ½æ ‡å‡†
- [ ] æ¥å£å“åº”æ—¶é—´æ»¡è¶³è¦æ±‚
- [ ] å¹¶å‘å¤„ç†èƒ½åŠ›è¾¾æ ‡
- [ ] ç³»ç»Ÿç¨³å®šæ€§ > 99.5%

### è´¨é‡æ ‡å‡†
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] ä»£ç è§„èŒƒæ£€æŸ¥é€šè¿‡
- [ ] å®‰å…¨æ¼æ´æ‰«æé€šè¿‡

---

**é¡¹ç›®è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ  
**åˆ›å»ºæ—¶é—´**: 2024å¹´12æœˆ  
**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**çŠ¶æ€**: å¼€å‘ä¸­ ğŸš§
