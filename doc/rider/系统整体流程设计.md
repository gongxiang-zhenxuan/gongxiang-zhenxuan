# 暹罗外卖系统整体流程设计

## 📋 系统概述

暹罗外卖系统采用Spring Cloud微服务架构，通过多个独立服务协同工作，提供完整的外卖下单、配送、支付和收入分配功能。

## 🏗️ 微服务架构

### 核心服务列表

| 服务名称 | 端口 | 职责 |
|---------|------|------|
| **siam-zuul** | 8080 | 网关服务，统一路由和权限控制 |
| **siam-order** | 9204 | 订单服务，核心业务逻辑 |
| **siam-user** | 9200 | 用户服务，用户信息和地址管理 |
| **siam-goods** | 9203 | 商品服务，商品信息和规格管理 |
| **siam-promotion** | 9205 | 促销服务，优惠券管理 |
| **siam-merchant** | 9201 | 商家服务，门店和商家信息 |
| **siam-rider** | 9202 | 骑手服务，骑手信息管理 |
| **siam-util** | 9207 | 工具服务，地图API和通用工具 |

## 🏗️ 系统架构图

### 微服务架构总览

```mermaid
graph TB
    subgraph 网关层
        GW[siam-zuul:8080<br/>API网关]
    end
    
    subgraph 业务服务层
        ORDER[siam-order:9204<br/>订单服务<br/>🔸核心下单逻辑<br/>🔸收入分配计算<br/>🔸支付回调处理]
        USER[siam-user:9200<br/>用户服务<br/>🔸身份验证<br/>🔸收货地址管理]
        GOODS[siam-goods:9203<br/>商品服务<br/>🔸商品信息查询<br/>🔸规格价格计算]
        PROMO[siam-promotion:9205<br/>促销服务<br/>🔸优惠券管理<br/>🔸优惠券验证]
        MERCHANT[siam-merchant:9201<br/>商家服务<br/>🔸门店信息管理<br/>🔸商家余额管理]
        RIDER[siam-rider:9202<br/>骑手服务<br/>🔸骑手信息管理<br/>🔸配送管理]
        UTIL[siam-util:9207<br/>工具服务<br/>🔸地图API调用<br/>🔸配送费计算]
    end
    
    subgraph 外部服务
        WX[微信支付API]
        BAIDU[百度地图API]
    end
    
    subgraph 数据存储
        MYSQL[(MySQL数据库)]
        REDIS[(Redis缓存)]
    end
    
    GW --> ORDER
    ORDER --> USER
    ORDER --> GOODS
    ORDER --> PROMO
    ORDER --> MERCHANT  
    ORDER --> UTIL
    UTIL --> BAIDU
    ORDER --> WX
    
    ORDER --> MYSQL
    USER --> MYSQL
    GOODS --> MYSQL
    PROMO --> MYSQL
    MERCHANT --> MYSQL
    RIDER --> MYSQL
    
    ORDER --> REDIS
    USER --> REDIS
    
    style ORDER fill:#ff9999
    style PROMO fill:#99ccff
    style UTIL fill:#99ff99
    style WX fill:#ffcc99
```

## 🔄 完整业务流程

### 业务流程总览

```mermaid
graph TD
    A[👤用户提交订单] --> B[🔍订单服务验证]
    B --> C{🎫是否使用优惠券?}
    C -->|是| D[📞调用促销服务<br/>验证优惠券]
    C -->|否| E[💰计算商品总价]
    D --> E
    E --> F{🚚是否配送?}
    F -->|是| G[📍调用工具服务<br/>计算配送费]
    F -->|否| H[💵计算最终金额]
    G --> H
    H --> I[📊计算收入分配<br/>平台/商家/骑手]
    I --> J[💾创建订单记录]
    J --> K[📱返回支付信息]
    K --> L[💳用户微信支付]
    L --> M[✅支付成功回调]
    M --> N[💰执行收入分配]
    N --> O[📋生成各方账单]
    O --> P[🎉订单创建完成]
    
    style A fill:#e1f5fe
    style B fill:#fff3e0
    style I fill:#e8f5e8
    style N fill:#ffcc99
    style P fill:#f3e5f5
```

### 详细服务交互流程

```mermaid
graph TD
    subgraph 用户端
        A["用户选择商品"] --> B["加入购物车/立即购买"]
        B --> C["选择收货地址"]
        C --> D["选择优惠券"]
        D --> E["确认订单"]
    end
    
    subgraph 订单服务 siam-order
        F["POST /rest/member/order/insert<br/>确认下单接口"]
        G["OrderServiceImpl.insert()"]
        H["订单数据校验"]
        I["计算商品总价"]
        J["计算配送费"]
        K["计算收入分配"]
        L["创建订单记录"]
        M["返回订单信息"]
    end
    
    subgraph 商品服务 siam-goods
        N["商品信息查询"]
        O["商品规格价格计算"]
        P["库存检查"]
    end
    
    subgraph 促销服务 siam-promotion
        Q["优惠券信息查询"]
        R["用户优惠券关系"]
        S["优惠券商品关联"]
        T["优惠券店铺关联"]
        U["优惠券使用验证"]
    end
    
    subgraph 商家服务 siam-merchant
        V["门店信息查询"]
        W["门店配送范围"]
        X["商家立减配送费"]
    end
    
    subgraph 用户服务 siam-user
        Y["用户身份验证"]
        Z["收货地址查询"]
        AA["用户会话管理"]
    end
    
    subgraph 工具服务 siam-util
        BB["百度地图距离计算"]
        CC["配送费计算规则"]
    end
    
    subgraph 支付流程
        DD["微信支付"]
        EE["支付成功回调"]
        FF["收入分配执行"]
        GG["账单记录生成"]
    end
    
    E --> F
    F --> G
    G --> H
    H --> I
    I --> J
    J --> K
    K --> L
    L --> M
    
    G --> Y
    G --> Z
    G --> V
    H --> N
    H --> Q
    I --> O
    I --> R
    J --> BB
    J --> W
    K --> X
    U --> S
    U --> T
    
    M --> DD
    DD --> EE
    EE --> FF
    FF --> GG
    
    style F fill:#e1f5fe
    style G fill:#fff3e0
    style DD fill:#e8f5e8
    style FF fill:#ffcc99
```

### 阶段一：用户下单流程

```mermaid
graph LR
    A["用户浏览商品"] --> B["添加购物车"]
    B --> C["选择收货地址"] 
    C --> D["选择优惠券"]
    D --> E["确认订单信息"]
    E --> F["提交订单"]
    
    style F fill:#e1f5fe
```

### 阶段二：订单处理流程（核心）

#### 2.1 订单服务入口
- **接口地址**: `POST /rest/member/order/insert`
- **服务**: `siam-order` (端口9204)
- **核心方法**: `OrderServiceImpl.insert()`

#### 2.2 服务调用序列

1. **用户身份验证**
   ```java
   // 调用用户服务验证Token
   Member loginMember = memberSessionManager.getSession(TokenUtil.getToken());
   ```

2. **商品信息验证**
   ```java
   // 调用商品服务获取商品详情
   Goods dbGoods = goodsFeignApi.selectByPrimaryKey(goodsId);
   // 计算商品规格价格
   BigDecimal specPrice = goodsSpecificationOptionFeignApi.selectSumPrice(...);
   ```

3. **优惠券处理** (来源: `siam-promotion`)
   ```java
   // 查询优惠券基本信息
   Coupons coupons = couponsFeignApi.selectByPrimaryKey(couponsId);
   // 查询用户优惠券关系
   CouponsMemberRelation relation = couponsMemberRelationFeignApi.select(...);
   // 验证优惠券商品关联
   List<Integer> goodsIds = couponsGoodsRelationFeignApi.getGoodsId(...);
   // 验证优惠券店铺关联
   List<Integer> shopIds = couponsShopRelationFeignApi.getShopId(...);
   ```

4. **门店信息查询**
   ```java
   // 调用商家服务获取门店信息
   Shop dbShop = shopFeignApi.selectByPrimaryKey(shopId);
   ```

5. **配送费计算** (配送订单)
   ```java
   // 获取收货地址
   DeliveryAddress address = deliveryAddressFeignApi.selectByPrimaryKey(addressId);
   // 调用地图API计算距离
   BigDecimal distance = baiduMapUtils.getTravelingDistance(...);
   // 计算配送费：起送1.5元 + 每增加1KM加1元
   BigDecimal deliveryFee = calculateDeliveryFee(distance);
   ```

6. **收入分配计算**
   ```java
   // 新规则：基于用户实际支付总金额统一抽成
   BigDecimal totalAmount = goodsActualAmount + deliveryFee;
   BigDecimal platformIncome = totalAmount × extractRatio;
   BigDecimal merchantIncome = goodsActualAmount × (1 - extractRatio);
   BigDecimal courierIncome = deliveryFee × (1 - extractRatio);
   ```

### 阶段三：支付和收入分配

#### 3.1 支付流程
- **微信支付**: 用户完成支付
- **回调处理**: `paymentNotify()` 方法

#### 3.2 收入分配执行
```java
// 商家收入进入冻结余额
merchant.orderFrozenBalance += merchantIncome;
// 骑手收入也暂时进入商家冻结余额(商家自配送)
merchant.orderFrozenBalance += courierIncome;
// 生成账单记录
createBillingRecord("订单收入", merchantIncome);
createBillingRecord("配送费收入", courierIncome);
```

## 💰 收入分配详细规则

### 计算公式

| 项目 | 计算公式 | 说明 |
|------|----------|------|
| **商品实付金额** | 商品原价 - 优惠券折扣 | 用户实际支付的商品费用 |
| **用户总支付** | 商品实付金额 + 配送费 | 用户实际支付总额 |
| **平台收入** | 商品实付 × 商户抽成比例 + 配送费 × 配送抽成比例 | 商户抽成比例按商户配置，订单创建时锁定入库 |
| **商家收入** | 商品实付金额 × (1 - 商户抽成比例) | 商户抽成比例可不同商户不同 |
| **骑手收入** | 配送费 × (1 - 配送抽成比例) | 配送抽成比例可平台统一/分区域 |

> 说明：商户抽成比例支持按商户单独配置（例如商家1=20%），并在“订单创建时”锁定到订单表，保证事后可追溯。

### 具体示例

**场景**: 30元商品，10元优惠券，2元配送费，10%抽成比例

```
商品实付 = 30 - 10 = 20元
用户总支付 = 20 + 2 = 22元
平台收入 = 22 × 10% = 2.2元
商家收入 = 20 × 90% = 18元
骑手收入 = 2 × 90% = 1.8元
验证: 2.2 + 18 + 1.8 = 22元 ✓
```

## 📊 详细调用序列图

```mermaid
sequenceDiagram
    participant U as 用户端
    participant G as 网关 siam-zuul
    participant O as 订单服务 siam-order
    participant US as 用户服务 siam-user  
    participant GS as 商品服务 siam-goods
    participant PS as 促销服务 siam-promotion
    participant MS as 商家服务 siam-merchant
    participant UT as 工具服务 siam-util
    participant WX as 微信支付
    
    U->>G: 1. 提交订单 POST /order/insert
    G->>O: 2. 路由到订单服务
    
    O->>US: 3. 验证用户身份 TokenUtil.getToken()
    US-->>O: 用户信息返回
    
    O->>GS: 4. 查询商品信息 goodsFeignApi
    GS-->>O: 商品详情和价格
    
    O->>GS: 5. 计算商品规格价格
    GS-->>O: 规格价格返回
    
    Note over O: 计算商品总价和包装费
    
    alt 用户使用优惠券
        O->>PS: 6. 查询优惠券信息 couponsFeignApi
        PS-->>O: 优惠券详情
        O->>PS: 7. 查询用户优惠券关系
        PS-->>O: 用户优惠券状态  
        O->>PS: 8. 查询优惠券商品关联
        PS-->>O: 可使用商品列表
        O->>PS: 9. 查询优惠券店铺关联  
        PS-->>O: 可使用店铺列表
        Note over O: 验证优惠券使用条件并计算优惠金额
    end
    
    O->>MS: 10. 查询门店信息 shopFeignApi
    MS-->>O: 门店详情和配置
    
    alt 配送订单
        O->>US: 11. 查询收货地址 deliveryAddressFeignApi
        US-->>O: 收货地址详情
        O->>UT: 12. 调用百度地图API计算距离
        UT-->>O: 骑行距离返回
        Note over O: 计算配送费(起送1.5元+距离费用)
        Note over O: 处理商家立减配送费
    end
    
    Note over O: 计算收入分配<br/>- 商品实付 × (1-抽成比例) = 商家收入<br/>- 配送费 × (1-抽成比例) = 骑手收入<br/>- 总金额 × 抽成比例 = 平台收入
    
    Note over O: 生成订单编号并创建订单记录
    
    O-->>G: 13. 返回订单信息
    G-->>U: 订单创建成功
    
    U->>WX: 14. 发起支付
    WX-->>U: 支付结果
    
    WX->>O: 15. 支付成功回调 paymentNotify
    
    Note over O: 执行实际收入分配<br/>- 商家收入进入冻结余额<br/>- 骑手收入进入冻结余额<br/>- 生成各方账单记录
    
    O->>MS: 16. 更新商家余额 merchantFeignApi  
    MS-->>O: 更新成功
    
    Note over O: 订单状态变更<br/>自取订单→待处理<br/>配送订单→待配送
```

## 🎯 关键接口列表

### 订单相关接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/rest/member/order/insert` | POST | 创建订单(核心接口) |
| `/rest/member/order/list` | POST | 订单列表查询 |
| `/rest/member/order/selectById` | POST | 订单详情查询 |
| `/rest/member/order/cancelOrder` | POST | 取消订单 |

### 服务间调用接口 (Feign)

| 服务调用 | 接口示例 |
|----------|----------|
| **商品服务** | `goodsFeignApi.selectByPrimaryKey()` |
| **用户服务** | `memberFeignApi.selectByPrimaryKey()` |
| **促销服务** | `couponsFeignApi.selectByPrimaryKey()` |
| **商家服务** | `shopFeignApi.selectByPrimaryKey()` |
| **工具服务** | `baiduMapUtils.getTravelingDistance()` |

## ⚙️ 配送费计算规则

### 距离计算
- **数据源**: 百度地图API骑行距离
- **起送价**: 1.5元 (0-1KM)
- **递增规则**: 每增加1KM加1元，向上取整
- **配送限制**: 超出5.5KM不予配送

### 商家立减支持
```java
if (商家立减金额 > 0) {
    if (商家立减金额 >= 总配送费) {
        商家承担配送费 = 总配送费;
        用户支付配送费 = 0;
    } else {
        商家承担配送费 = 商家立减金额;
        用户支付配送费 = 总配送费 - 商家立减金额;
    }
}
```

## 🔐 安全和容错机制

### 数据校验
- 前后端双重价格计算验证
- 优惠券使用条件严格校验  
- 库存和商品状态实时检查

### 事务保障
- 分布式事务支持(Seata)
- RocketMQ消息队列保障
- 本地消息表机制

### 异常处理
- 服务降级和熔断
- 订单超时自动取消
- 支付异常回滚机制

## 📊 监控指标

### 业务指标
- 订单转换率
- 平均订单金额
- 配送费收入占比
- 优惠券使用率

### 技术指标
- 服务响应时间
- 接口成功率
- 数据库连接池状态
- 消息队列堆积情况

## 🚀 扩展性设计

### 水平扩展
- 微服务独立部署
- 数据库读写分离
- Redis缓存集群

### 业务扩展
- 支持多种配送方式
- 灵活的抽成比例配置
- 多样化的优惠活动

---

**文档版本**: v1.0  
**创建时间**: 2024年  
**维护团队**: 技术架构组
